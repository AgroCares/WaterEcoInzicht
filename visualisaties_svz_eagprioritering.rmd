---
title: "Stand van zaken ecologische waterkwaliteit"
subtitle: "Verschillende visualisaties tbv jaarlijkse rapportages en prioritering gebieden"
author: Laura Moria
always_allow_html: yes
site: bookdown::bookdown_site
output:
  bookdown::word_document2:
    reference_docx: NMI Rapport Template 2022.dotx 
  bookdown::html_document2:
    theme: sandstone
    fig_caption: yes
    number_sections: yes
    toc: yes
    link-citations: yes
documentclass: book
css: style.css
biblio-style: apa
editor_options: 
  chunk_output_type: console
---

```{r global, include = FALSE}
###INSTELLINGEN -----------------------------
rm(list=ls())  

library(data.table) 
library(purrr);library(tidyr)#voor trend
library(sf)
library(gridExtra)
library(plotly)
library(ggspatial)
library(raster)
library(leaflet)

source('./scripts/ppr_funs_waterecoinzicht.R')

# other settings
proj4.rd <- 28992
proj4.google <-4326

```

```{r data, include = FALSE}
# load maps/ kaarten laden
EAG<- st_read("./data/EAG_20220809.gpkg") %>% st_transform(proj4.rd)
gEAG <- EAG %>% st_transform(proj4.google)
# shape met al het water in EAG
waterpereag <- sf::st_read("./data/WaterPerEAG_20220809.gpkg") %>% sf::st_transform(proj4.rd)
# load data
# hydrobiology
hybi <- readRDS('./data/hybi.rds') %>% as.data.table()
# KRW toetsresultaten
EKRset <- readRDS('./data/krw/EKRset.rds') %>% as.data.table()
trendekreag <- readRDS('./data/krw/trendekreag.rds')  %>% as.data.table()
# waterkwaliteit
wq <- readRDS('./data/wq.rds') %>% as.data.table()
# slootbodem/ sediment measurements ---------------
bod  <- fread("./data/bodemfews.csv")
bod <- ppr_slootbodem(db = bod, wtype = eag_wl, mlocs = locaties)
# p loads and critical loads
dat <- readRDS("./data/dat.rds")  
dat[,date := as.POSIXct(paste0(jaar,"-",maand,"-01"), format = '%Y-%m-%d')]
# only last version of waterbalance
dat <- dat[dat$selectiefilter == 1,]
#kaart met berekende retentie
dat$p_retentie <- dat$wp_min_sum - dat$wp_meting_mgm2d
# table with kP for different debiet, depth and soiltype
nomogram <- data.table::fread('./data/nomogram.csv')
# datafile with P-load PC Ditch
Overzicht_kP <- data.table::fread('./data/Overzicht_kP.csv')
Overzicht_kP <- ppr_pcditch(db = Overzicht_kP)
pvskp <- ppr_pmaps(dat, Overzicht_kp, hybi, nomogram, pYEAR = TRUE)

#bodemschat
bodemschatAGV<- st_read("./data/bodemschatAGV.gpkg") %>% st_transform(proj4.rd)
# agrarische percelen
brpAGV <- st_read('./data/brpAGV.gpkg')%>% st_transform(proj4.rd)
gbrpAGV <- brpAGV %>% st_transform(proj4.google)

```

```{r make subdatasets with relevant pars and aggrgate per eag, include = FALSE}
# ekr scores ----------
# mean ekr per locatie en year
krwloc <- calc_mean_EKR(db = EKRset, nyears = 22, pEAG = FALSE, pYEAR = TRUE, pSEASON = FALSE)
# update mp-id
krwloc[,mpid2 := tstrsplit(mpid,'_',keep=1)]
# aggregate per EAG and year
krw <- calc_mean_EKR(db = EKRset, nyears = 22, pEAG = TRUE, pYEAR = TRUE, pSEASON = FALSE)
krwflora <- krw[krw$GHPR_level == "2V1 Overige waterflora" , ] # alleen maatlat flora

# waterkwaliteit-------------
# per location, given season and year
wq.sel <- wq[,.(locatiecode,fewsparameter,meetwaarde,jaar,maand)]
wq.sel[,season := fifelse(maand %in% 4:10,'summer','winter')]
# selectie relevant parameters
wq.par <- c('Ptot_mgP_l','PO4_mgP_l_nf',"NO3_mgN_l_nf","Ntot_mgN_l_nf",'NH4_mgN_l_nf',"ZICHT_m","Cl_mg_l" ,
           'O2_mg_l','pH','T_oC','SO4_mg_l',"SO4_mg_l_nf",'CHLFa_ug_l',
           "CHLFa_ug_l_blauwalg" , "Ca_mg_l",
           "Ca_mg_l_nf",'MGETAL_mgHCO3_l',"MGETAL_mgHCO3_l_nf","Mg_mg_l","Mg_mg_l_nf","ZS_mg_l" )
wq.sel <- wq.sel[fewsparameter %in% wq.par]
# samenvoegen parameters met verschillende gerapporteerde hoedanigheid, maar waarschijnlijk zelfde methode
wq.sel$fewsparameter <- gsub('_nf','',wq.sel$fewsparameter) 
wq.sel.wide <- dcast(wq.sel,locatiecode+jaar+season~fewsparameter, value.var = 'meetwaarde', fun.aggregate = median)
wq.sel.wide$mp_yr <- paste0(wq.sel.wide$locatiecode,wq.sel.wide$jaar)

# bodem ---------------
# selecteer monsters waar vaste bodem ondet baggerlaag is gemeten
bodsel <- bod$monsterident[bod$fewsparameter %in% c("Ptot_mgPOlsen_l_ng","Ptot_mgPOlsen_kg_dg")]
bod <- bod[!bod$monsterident %in% bodsel,]
bod$fewsparameter <- gsub('_nf','',bod$fewsparameter) 
# nalevering en ijzerval berekenen voor koppeling of ruwe data
bod.sel.wide <- dcast(bod,locatiecode+jaar~fewsparameter, value.var = 'meetwaarde', fun.aggregate = median)
bod.sel.wide.eag <- dcast(bod,EAGIDENT~fewsparameter, value.var = 'meetwaarde', fun.aggregate = median)

# bodemschat gewogen gemiddelde per EAG -------------------
bodemschatAGV$oppvl <- st_area(bodemschatAGV)
bs <-as.data.table(bodemschatAGV)
bs[,GAF_ID := sapply(strsplit(GAFIDENT, '-'), `[`, 1)]
bs[,totoppvleag := sum(oppvl), by = 'GAFIDENT' ]
bs[,gewicht := oppvl/totoppvleag]
bs[,totoppvlgaf := sum(oppvl), by = 'GAF_ID' ]
bs[,gewichtgaf := oppvl/totoppvlgaf]
cols <- c('A_P_AL','A_P_OX','A_P_SG')
aggbseag <- bs[, lapply(.SD, function(x) sum(x * gewicht)),.SDcols = cols, by = c('GAFIDENT','totoppvleag')]
aggbsgaf <- bs[, lapply(.SD, function(x) sum(x * gewichtgaf)),.SDcols = cols, by = c('GAF_ID','totoppvlgaf')]

```

```{r spacial join loc bod, wq and hybi}

if(koppellocation){
## koppelen data hybi aan hybi, bod en wq ----
  # wellicht beter om dit te doen obv locaties in gefilterde datasets (EST, wqsel, bodsel)
# check if locs bod and wq are present in locaties
loc.mis <- unique(bod$locatiecode[!bod$locatiecode %in% locaties$CODE])
loc.mis <- unique(EKRset$CODE[!EKRset$CODE %in% locaties$CODE]) # 5
loc.mis <- unique(hybi$locatiecode[!hybi$locatiecode %in% locaties$CODE])
loc.mis <- unique(hybi$locatiecode[!hybi$locatiecode %in% unique(EKRset$CODE)]) # bij merge van toetsgegevens en biologie valt de emerse zone meren en plassen weg, visdata en data < 2006

# search for water quality measurement points that occur within a distance of 1000m and the same EAG 
# selection wq/bod loc per year
wq.loc <-  unique(wq[,c('locatiecode', 'jaar','locatie x','locatie y','EAGIDENT')])
bod.loc <-  unique(bod[,c('locatiecode', 'jaar','locatie x','locatie y','EAGIDENT')])
hybi.loc <- unique(hybi[,c('locatiecode', 'jaar','locatie.x','locatie.y','EAGIDENT')])

# make spatial
wq.loc <- sf::st_as_sf(wq.loc, coords = c('locatie x','locatie y'), crs = 28992)
bod.loc <- sf::st_as_sf(bod.loc, coords = c('locatie x','locatie y'), crs = 28992)
hybi.loc <- sf::st_as_sf(hybi.loc, coords = c('locatie.x','locatie.y'), crs = 28992)

# combine hybi, wq en bod sets with closest distance within the same EAG 
wq.kop <- NULL # i <- 991 heeft bod, wq en hybi data
for(i in unique(paste0(hybi.loc$locatiecode,hybi.loc$jaar))){
    hybi.mp <- hybi.loc[paste0(hybi.loc$locatiecode,hybi.loc$jaar) == i,]
    wq.loc.sel <- wq.loc[wq.loc$EAGIDENT == unique(hybi.mp$EAGIDENT) & 
                           wq.loc$jaar == unique(hybi.mp$jaar),]
    bod.loc.sel <- bod.loc[bod.loc$EAGIDENT == unique(hybi.mp$EAGIDENT),] # hier geen jaar omdat er   maar 1 meting is
    if(nrow(wq.loc.sel) == 0){
      if(nrow(bod.loc.sel) == 0){
      x <- cbind(i,hybi.mp$locatiecode,hybi.mp$jaar,NaN,NaN,NaN,NaN,unique(hybi.mp$EAGIDENT))}
      if(nrow(bod.loc.sel) > 0){
      nearest.bod <- bod.loc.sel$locatiecode[which.min(st_distance(hybi.mp, bod.loc.sel, byid=TRUE))]
      dist.bod <- min(st_distance(hybi.mp, bod.loc.sel, byid=TRUE))
      x <- cbind(i,hybi.mp$locatiecode,hybi.mp$jaar,NaN,NaN,nearest.bod,dist.bod,unique(hybi.mp$EAGIDENT))
      }
    }
    if(nrow(wq.loc.sel) > 0){
      nearest.wq <- wq.loc.sel$locatiecode[which.min(st_distance(hybi.mp, wq.loc.sel, byid=TRUE))]
      dist.wq <- min(st_distance(hybi.mp, wq.loc.sel, byid=TRUE))
      if(nrow(bod.loc.sel) == 0){
        x <- cbind(i,hybi.mp$locatiecode,hybi.mp$jaar,nearest.wq,dist.wq,NaN,NaN,unique(hybi.mp$EAGIDENT))}
      if(nrow(bod.loc.sel) > 0){ 
      nearest.bod <- bod.loc.sel$locatiecode[which.min(st_distance(hybi.mp, bod.loc.sel, byid=TRUE))]
      dist.bod <- min(st_distance(hybi.mp, bod.loc.sel, byid=TRUE))
      x <- cbind(i,hybi.mp$locatiecode,hybi.mp$jaar,nearest.wq,dist.wq,nearest.bod,dist.bod,unique(hybi.mp$EAGIDENT))
      }
    }
    print(x)
    wq.kop <- rbind(x, wq.kop)
}

wq.kop <- as.data.table(wq.kop)
setnames(
  wq.kop,
  c("i", "V2", "V3", "V4" ,"V5" ,"V6" ,"V7", "V8"),
  c("mp_yr", "jaar","locatiecode", "nearest.wq", "dist.wq","nearest.bod", "dist.bod", "EAGIDENT")
)
saveRDS(wq.kop, 'output/wq.kop.rds')
}else{ 
  fname <- list.files('output')
  fname <- sort(fname[grepl('^wq.kop',fname)],decreasing = TRUE)[1]
  # read maatregelen
  wq.kop <- readRDS(paste0('output/',fname))
  }

# TODO: spatial join perceelsdata aan ekr
```

# Data verkenning - waterbalansen

```{r belasting controle input waterbalansen}

#kaart met p uitpoel en p afstroming
ppr_mapPpercWatb(pvskp, gEAG,param = 'p_uitspoel')
ppr_mapPpercWatb(pvskp, gEAG,param = 'p_afstroom')
ppr_mapPpercWatb(pvskp, gEAG,param = 'p_inlaat5')
ppr_mapPpercWatb(wb_perc, gEAG,param = 'A_P_AL')
ppr_mapPpercWatb(pvskp, gEAG, param = 'a_tot')

#vergelijk P-uitspoel en pal,
#nu alleen perceelsgegevens per gaf, update gegevens
p <- ggplot(wb_perc, aes(x= p_uitspoel, y= A_P_OX, col= agrper,label = paste0(GAF, ',',EAG)))+
    geom_jitter() +
    # scale_x_continuous(limits= c(0, 1.5)) +
    # scale_y_continuous(limits= c(0, 50)) +
    theme_minimal()+
    theme(
      strip.background = element_blank(),
      strip.text.x = element_text(size = 6), 
      strip.text.y = element_text(size = 5), 
      axis.text.x = element_text(size= 8, hjust=1),
      axis.text.y = element_text(size= 8, hjust=2),
      axis.ticks =  element_line(colour = "black"),
      panel.background = element_blank(),
      plot.background = element_blank()
    )+
    ggtitle('') +
    #guides(col = '') +
    labs(x= 'p uitspoel wb' , y= 'p_ox')
ggplotly(p=p) 

p <- ggplot(checkarea, aes(x= oppvl, y= a_tot, label = paste0(EAG)))+
    geom_jitter() +
    # scale_x_continuous(limits= c(0, 1.5)) +
    # scale_y_continuous(limits= c(0, 50)) +
    theme_minimal()+
    theme(
      strip.background = element_blank(),
      strip.text.x = element_text(size = 6), 
      strip.text.y = element_text(size = 5), 
      axis.text.x = element_text(size= 8, hjust=1),
      axis.text.y = element_text(size= 8, hjust=2),
      axis.ticks =  element_line(colour = "black"),
      panel.background = element_blank(),
      plot.background = element_blank()
    )+
    ggtitle('') +
    #guides(col = '') +
    labs(x= 'opp EAG' , y= 'opp balans')
ggplotly(p=p) 

```

In het westen van het beheergebied van AGV zijn de perceelsconcentraties voor uitspoeling en afstroming die zijn gebruikt in stoffenbalansen over het algemeen hoger dan in het oosten. Er is dan ook sprake van een sterke ruimtelijke gradiënt met hogere kalkgehaltes in het westen van het gebied en lagere kalkgehaltes in het oosten. Deze grens komt overeen tot waar de mariene invloed uit het verleden heeft gereikt. Polders met veel invloed van mariene sedimenten worden over het algemeen gekenmerkt door voedselrijkere percelen. Wat opvalt is dat er in de natuurgebieden ten westen van het ARK een hogere perceelsconcentrtatie wordt gebruikt dan in de agrarische gebieden en dat er lagere perceelsconcentraties worden gebruikt in Baambrugge Oostzijds en de Tweede bedijking.
De gehanteerde perceelsconcentraties komen niet altijd overeen met de gemeten PAL-waarden (fosfaattoestand) in percelen; In Baambrugge Oostzijds wordt juist een hogere fosfaattoestand gemeten in de percelen dan in de naastgelegen Baambrugge Westzijds. In Wilnis Veldzijde, de Derde bedijking is de gemeten fosfaattoestand lager dan in Gagelweg en polder Oukoop.

Ook springen het Hol, de Oostelijke Binnenpolder en Terra Nova eruit. Hier zijn gebruikte concentraties veel lager dan gebieden in hun omgeving.

```{r berekende retentie waterbalansen en metingen}
# add critical load based on debiet, diepte, soiltype
ret <- ppr_pmaps(ret, Overzicht_kp, hybi, nomogram)
ppr_mapPpercWatb(ret, gEAG,param = 'p_retentie')
```

# Overig 

```{r kaarten ekr scores, include=FALSE, eval=FALSE}
# kaart maken per eag en parameter, pdf worden geexporteerd naar output/
# update mp-id

krwloc[,gebied := tstrsplit(EAGIDENT,'-',keep=1)]
dt = krwloc[!grepl("aantalper*",krwloc$GHPR, fixed =F) & krwloc$wbmethode == "ml_2018_ov.wflora",]
#dt = dt[dt$GHPR %in% c("Overige waterflora-kwaliteit","Soortensamenstelling macrofyten","Soortensamenstelling macrofyten Oeverplanten", "Soortensamenstelling macrofyten Waterplanten", "Bedekking som submerse planten en draadalgen")]

#oefenset
dt <- dt[dt$gebied %in% c('2120','2501','4100','2400'),]

gebieden <- unique(dt$gebied)
gEAG <- EAG %>% st_transform(4326)
# shape met al het water in EAG
waterpereag <- sf::st_read("../data/WaterPerEAG20191205.gpkg",quiet = T) %>% sf::st_transform(4326)
glocs <- st_as_sf(locaties[!is.na(locaties$XCOORD),], coords = c('XCOORD','YCOORD'), crs = proj4.rd) %>% st_transform(4326)

for(gb in gebieden){
  #gb <- gebieden[1]
  EAGsel <- gEAG[grepl(gb, gEAG$GAFIDENT),]
  waterpereagsel <- waterpereag[grepl(gb, waterpereag$GAFIDENT),]
  dt1 <- dt[dt$gebied == gb,]
  for(yr in unique(dt1$jaar)){
    #yr <- unique(dt1$jaar)[1]
    dt2 <- dt1[dt1$jaar == yr,]
    for (i in unique(dt2$GHPR)){
    # i <- unique(dt2$GHPR)[1]
    kaartEKRmp(dt = dt2[dt2$GHPR == i,],
               EAGsel = EAGsel,
               waterpereagsel = waterpereagsel,
               glocs = glocs,
               ekr_col = c("red", "orange", "yellow", "green"),
               ekr_labels = c("slecht","ontoereikend","matig","goed"), 
               ekr_breaks = c(0, 0.2, 0.4, 0.6, 1))
    }
    }
}

```

```{r waterkwaliteit, include=FALSE, eval = FALSE}
# Summer mean wq on locations were measures were measures are executed
# wq.sel$season == "summer" 

plot <- ggplot(data= wq.sel[wq.sel$fewsparameter == "CHLFa_ug_l" & wq.sel$locatiecode %in% c( 'BOT002') & wq.sel$jaar < 2022,], aes(x=jaar, y=meetwaarde, col= locatiecode, fill = locatiecode, group = jaar))+
    geom_point(stat = "summary", fun = "mean")+
    geom_line(stat = "summary", fun = "mean")+   
    #facet_wrap(.~fewsparameter)+
    theme_minimal()+
    ggtitle('')+ ylab('Chlorofyl-A (ug/l)')+ xlab('jaar')+
    theme (axis.text.x =element_text(angle=90, vjust=1))
ggplotly(p=plot)



plot <- ggplot(data= wq[wq$fewsparameter == "Ptot_mgP_l" & wq$locatiecode %in% c( 'OBT006','PMW057', 'PMW052') & wq$jaar >2015,], aes(x=datum, y=meetwaarde, col= locatiecode, fill = locatiecode))+
    geom_point()+
    geom_line()+
    #facet_wrap(.~fewsparameter)+
    theme_minimal()+
    ggtitle('')+ ylab('Totaal fosfor (mg/l)')+ xlab('datum')+
    theme (axis.text.x =element_text(angle=90, vjust=1))
ggplotly(p=plot)

# kaart met alle location en EAG
loc <- st_as_sf(locaties[!is.na(locaties$XCOORD),], coords = c('XCOORD','YCOORD'), crs = proj4.rd) %>% st_transform(4326)

leaflet() %>%
  addTiles() %>%
  # addCircles(data = loc, , popup= paste("loc naam", loc$CODE)) %>%
  addPolygons(data = gEAG[gEAG$GAFIDENT == "6580-EAG-1",], popup= paste("EAG naam", gEAG$GAFNAAM, "EAG", gEAG$GAFIDENT))
  
```

```{r prioritairgebied, include=FALSE, eval = FALSE}
# voorbewerking data samenvoegen om alle nodige info aan EAG's te koppelen ----------------------
# koppel agrarische percelen EAG
brpAGV$agropp <- as.numeric(st_area(brpAGV))
brpAGV <- brpAGV[brpAGV$category %in% c('Grasland','Bouwland'),]
brpAGV <- brpAGV %>% as.data.table()
brpAGV <- brpAGV[,agropptot := sum(as.numeric(agropp)), by = GAFIDENT]
#bereken relatie oppervlak agrarisch
eag_wl <- merge(eag_wl, brpAGV[,c('GAFIDENT','agropptot')], by = 'GAFIDENT', all.x = TRUE, all.y = FALSE)
eag_wl <- unique(eag_wl)
eag_wl$relagr <- eag_wl$agropptot/eag_wl$OppLand

# koppel doelgat en potentie aan EAGs
gEAG <- merge(gEAG, eag_wl[,-c('GAFNAAM')], by = 'GAFIDENT', all.x = TRUE)
gEAG$gaf <- unlist(tstrsplit(gEAG$GAFIDENT,'-',keep=1))
krw2 <- calc_mean_EKR(db = EKRset, nyears = 3, pEAG = TRUE, pYEAR = FALSE, pSEASON = FALSE)
krw2flora <- krw2[krw2$GHPR_level == "2V1 Overige waterflora", ] # alleen maatlat flora
# colsNotMerge <- as.data.table(colnames(krw2flora)[colnames(krw2flora) %in% colnames(gEAG)])
gEAG <- merge(gEAG, krw2flora[!is.na(krw2flora$EAGIDENT), -c("watertype","KRW_SGBP3")], by.x = 'GAFIDENT', by.y ='EAGIDENT', all.x = TRUE, all.y = FALSE) 
gEAG$doelgat <- gEAG$GEP_2022-gEAG$EKR
potentie <- data.table::fread('../data/PotentieFlora_analDoelOvwat.csv')
gEAG<- merge(gEAG, potentie, by.x = 'GAFIDENT', by.y ='EAGIDENT', all.x = TRUE, all.y = FALSE) 
gEAG <- gEAG[!is.na(gEAG$GAFIDENT),] #lege EAGs verwijderen

# per proces voor visualisatie --------------------
# doelgat 
'3' -> gEAG$doelgatft[gEAG$doelgat >= 0.2]
'4' -> gEAG$doelgatft[gEAG$doelgat < 0.2 & gEAG$doelgat >= 0.1]
'5' -> gEAG$doelgatft[gEAG$doelgat < 0.1 ]
gEAG$doelgatft <- as.factor(gEAG$doelgatft)
gEAG$doelgatft = factor(gEAG$doelgatft, levels = c("3", "4", "5")) 
col <- c('3'="blue",'4'="deepskyblue",'5'= "yellow")
labelsdoelgat <- c('3'='>0.2','4'='0.1-0.2','5'='< 0.1')

# EAGs met hoge potentie
'5' -> gEAG$potentieft[gEAG$potentie < 0.5] #gEAG$Doel_2022 >= 0.4 & 
'4' -> gEAG$potentieft[gEAG$potentie >= 0.5 & gEAG$potentie < 0.6]
'3' -> gEAG$potentieft[gEAG$potentie >= 0.6]
gEAG$potentieft <- as.factor(gEAG$potentieft)
gEAG$potentieft = factor(gEAG$potentieft, levels = c("3", "4", "5"))   
col <- c('3'="blue",'4'="deepskyblue",'5'= "yellow")
labelspot <- c('3'='>0.6', '4'='0.5-0.6','5'= '<0.5')

# selectie type EAGs ----------------------------------
#alleen agrarische EAGs
agEAG <- gEAG[gEAG$GAFIDENT %in% brpAGV$GAFIDENT & gEAG$relagr > 0.5 & gEAG$agropptot > 100000 | gEAG$GAFIDENT %in% '2130-EAG-1',] # va 0.35 kortenhoef en sap ook
gEAG$kaarttype[gEAG$GAFIDENT %in% brpAGV$GAFIDENT & gEAG$relagr > 0.5 & gEAG$agropptot > 100000 | gEAG$GAFIDENT %in% '2130-EAG-1'] <- 'agrarisch'
# stedelijk
stedEAG <- gEAG[gEAG$StedelijkLandelijk == 'Stedelijk' & !(gEAG$GAFIDENT %in% c(agEAG$GAFIDENT)),]
gEAG$kaarttype[gEAG$StedelijkLandelijk == 'Stedelijk' & !(gEAG$GAFIDENT %in% c(agEAG$GAFIDENT))] <- 'stedelijk'
# overig
ovEAG <- gEAG[!(gEAG$GAFIDENT %in% c(stedEAG$GAFIDENT, agEAG$GAFIDENT)),]
gEAG$kaarttype[!(gEAG$GAFIDENT %in% c(stedEAG$GAFIDENT, agEAG$GAFIDENT))] <- 'natuur'
# meren en boezem (waterbeheer)
gEAG$kaarttype[substr(gEAG$GAFIDENT,2,4)  %in% '000'] <- 'boezem'
gEAG$kaarttype[gEAG$watertype %in% c('M14',"M25", "M27", "M11", "M20")] <- 'meren'

#koppel water aan eag ---------------------------------------
gwaterpereag <- waterpereag %>% st_transform(proj4.google)
gEAG2 <- gEAG %>% st_drop_geometry()
watEAG <- merge(gwaterpereag, as.data.table(gEAG2), by = "GAFIDENT")

# kaarten -----------------------
# KRW water per categorie EAGs
WL <- gEAG[!(is.na(gEAG$SGBP3_NAAM)|gEAG$SGBP3_NAAM == ""),]
# WL <- gEAG[(is.na(gEAG$SGBP3_NAAM)|gEAG$SGBP3_NAAM == ""),]
WL <- watEAG[!(is.na(watEAG$SGBP3_NAAM)|watEAG$SGBP3_NAAM == ""),]
paltype <- colorFactor(palette = 'viridis',  domain = WL$kaarttype) 

leaflet() %>%
  addPolygons(data = WL,
              layerId = WL$GAFIDENT,
              popup= paste("EAG naam", WL$GAFNAAM, "relatief agrarisch", WL$relagr),
              stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
              fill=T, fillColor = ~paltype(WL$kaarttype), fillOpacity = 0.5) %>%
  addLegend("bottomright",  pal=paltype, values=WL$kaarttype, title = "KRW-waterlichamen")%>%
  addProviderTiles("Esri.WorldGrayCanvas") 

# saveWidget(m, "temp.html", selfcontained = FALSE)
# webshot("temp.html", file = "KRW-waterlichamen.png",
#         cliprect = "viewport")


# Agrarische EAGs
leaflet() %>%
  addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.2, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = ovEAG,
              layerId = ovEAG$GAFIDENT,
              popup= paste("EAG naam", ovEAG$GAFNAAM.x),
              stroke = T, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
              fill=T, fillColor = 'blue', fillOpacity = 0.5) %>%
  addProviderTiles("Esri.WorldGrayCanvas") 


# doelgat kaart
paldoelgat <- colorFactor(palette = col,  domain = agEAG$doelgatft) 
paldoelgat <- colorFactor(palette = col,  domain = stedEAG$doelgatft)
paldoelgat <- colorFactor(palette = col,  domain = ovEAG$doelgatft)

leaflet() %>%
  addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.2, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = ovEAG, layerId = ovEAG$GAFIDENT,
  popup= paste("EAG naam", ovEAG$GAFNAAM.x),
  stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
  fill=T, fillColor = ~paldoelgat(ovEAG$doelgatft), fillOpacity = 0.5) %>%
  addLegend("bottomright", colors=col, labels=labelsdoelgat, title = "Doelgat KRW & Overig water")%>%
  addProviderTiles("Esri.WorldGrayCanvas") 

# EAGs met plassen of die afwateren op plassen
plasgaf <- unique(gEAG$gaf[gEAG$OWMTYPE_WBP %in% c('M14',"M25", "M27", "M11", "M20")]) # selectie afvoergebieden met plassen
plasgaf <- c(plasgaf, '3302','8090','8030') #toevoegen afvoergebieden die afwateren op plassen (ipv boezem)
plaseag <- unique(gEAG$GAFIDENT[gEAG$gaf %in% plasgaf]) # EAGs in plasgafs
plaseag <- plaseag[!plaseag %in% c('2250-EAG-2','2250-EAG-3','2250-EAG-4','2250-EAG-5','2250-EAG-6','2250-EAG-7','2220-EAG-5','2220-EAG-6','2220-EAG-7','2550-EAG-5','2250-EAG-3','3110-EAG-5')] # weglaten EAGs die niet afwateren op plassen

#& gEAG[gEAG$GAFIDENT %in% plaseag & !gEAG$GAFIDENT %in% agEAG$GAFIDENT = zonder doelgat
plasagEAG <- agEAG[agEAG$GAFIDENT %in% plaseag,]
paldoelgat <- colorFactor(palette = col,  domain = plasagEAG$doelgatft) 
leaflet() %>%
  addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.05, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = plasagEAG, layerId = plasagEAG$GAFIDENT,
  popup= paste("EAG naam", plasagEAG$GAFNAAM.x),
  stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
  fill=T, fillColor = ~paldoelgat(plasagEAG$doelgatft), fillOpacity = 0.5) %>%
  addLegend("bottomright", colors=col, labels=labelsdoelgat, title = "Doelgat KRW & Overig water")%>%
  addProviderTiles("Esri.WorldGrayCanvas")  

plasstedEAG <- stedEAG[stedEAG$GAFIDENT %in% plaseag,]
paldoelgat <- colorFactor(palette = col,  domain = plasstedEAG$doelgatft) 
leaflet() %>%
  addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.05, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = plasstedEAG, layerId = plasstedEAG$GAFIDENT,
  popup= paste("EAG naam", plasstedEAG$GAFNAAM.x),
  stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
  fill=T, fillColor = ~paldoelgat(plasstedEAG$doelgatft), fillOpacity = 0.5) %>%
  addLegend("bottomright", colors=col, labels=labelsdoelgat, title = "Doelgat KRW & Overig water")%>%
  addProviderTiles("Esri.WorldGrayCanvas")  

plasovEAG <- ovEAG[ovEAG$GAFIDENT %in% plaseag,]
paldoelgat <- colorFactor(palette = col,  domain = plasovEAG$doelgatft) 
leaflet() %>%
  addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.05, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = plasovEAG, layerId = plasovEAG$GAFIDENT,
  popup= paste("EAG naam", plasovEAG$GAFNAAM.x),
  stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
  fill=T, fillColor = ~paldoelgat(plasovEAG$doelgatft), fillOpacity = 0.5) %>%
  addLegend("bottomright", colors=col, labels=labelsdoelgat, title = "Doelgat KRW & Overig water")%>%
  addProviderTiles("Esri.WorldGrayCanvas")  

# kaart potentie agrarisch
agEAGdg <- agEAG
palpot <- colorFactor(palette = col,  domain = agEAGdg$potentieft)

leaflet() %>%
  addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.05, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = agEAGdg, layerId = agEAGdg$GAFIDENT,
    popup= paste("EAG naam", agEAGdg$GAFNAAM.x, 'potentie ',agEAGdg$potentie, 'doelgat ', agEAGdg$doelgat),
    stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
    fill=T, fillColor = ~palpot(agEAGdg$potentieft), fillOpacity = 0.5) %>%
  addLegend("bottomright", colors=col, labels=labelspot, title = "Potentie")%>%
  addProviderTiles("Esri.WorldGrayCanvas")

# Niet agrarisch, wel doelgat, potentie en plassen
'5' -> gEAG$potentieft[gEAG$potentie < 0.5] #gEAG$Doel_2022 >= 0.4 & 
'4' -> gEAG$potentieft[gEAG$potentie >= 0.5 & gEAG$potentie < 0.6]
'3' -> gEAG$potentieft[gEAG$potentie >= 0.6]
gEAG$potentieft <- as.factor(gEAG$potentieft)
gEAG$potentieft = factor(gEAG$potentieft, levels = c("3", "4", "5"))   
col <- c('3'="blue",'4'="deepskyblue",'5'= "yellow")
labelspot <- c('3'='>0.6', '4'='0.5-0.6','5'= '<0.5')

# alleen plas, potentie en doelgat
gEAGdg <- gEAG[gEAG$doelgat > 0.1 & gEAG$GAFIDENT %in% plaseag & !(gEAG$GAFIDENT %in% agEAG$GAFIDENT) & gEAG$relagr > 0.10 & gEAG$aggopptot > 100000,]
palpot <- colorFactor(palette = col,  domain = gEAGdg$potentieft)

leaflet() %>%
  addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.05, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.2) %>%
  addPolygons(data = gEAGdg, layerId = gEAGdg$GAFIDENT,
    popup= paste("EAG naam", gEAGdg$GAFNAAM.x, 'potentie ',gEAGdg$potentie, 'doelgat ', gEAGdg$doelgat,'aggopp ', gEAGdg$aggopptot),
    stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
    fill=T, fillColor = ~palpot(gEAGdg$potentieft), fillOpacity = 0.9) %>%
  addLegend("bottomright", colors=col, labels=labelspot, title = "Potentie")%>%
  addProviderTiles("Esri.WorldGrayCanvas")

# niet agrarisch, klein doelgat, veel potentie en afwaterend op plassen
agEAGdg <- gEAG[gEAG$doelgat <=0.1 & gEAG$GAFIDENT %in% plaseag & !(gEAG$GAFIDENT %in% agEAG$GAFIDENT) & gEAG$relagr > 0.10 & gEAG$agropptot > 100000,]
palpot <- colorFactor(palette = col,  domain = agEAGdg$potentieft)

leaflet() %>%
  addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.05, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = agEAGdg, layerId = agEAGdg$GAFIDENT,
    popup= paste("EAG naam", agEAGdg$GAFNAAM.x, 'potentie ',agEAGdg$potentie, 'doelgat ', agEAGdg$doelgat),
    stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
    fill=T, fillColor = ~palpot(agEAGdg$potentieft), fillOpacity = 0.5) %>%
  addLegend("bottomright", colors=col, labels=labelspot, title = "Potentie")%>%
  addProviderTiles("Esri.WorldGrayCanvas")

# kaart potentie stedelijk
stedEAGdg <- stedEAG
palpot <- colorFactor(palette = col,  domain = stedEAGdg$potentieft)

leaflet() %>%
  addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.05, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = stedEAGdg, layerId = stedEAGdg$GAFIDENT,
    popup= paste("EAG naam", stedEAGdg$GAFNAAM.x, 'potentie ',stedEAGdg$potentie, 'doelgat ', stedEAGdg$doelgat),
    stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
    fill=T, fillColor = ~palpot(stedEAGdg$potentieft), fillOpacity = 0.5) %>%
  addLegend("bottomright", colors=col, labels=labelspot, title = "Potentie")%>%
  addProviderTiles("Esri.WorldGrayCanvas")

# kaart potentie overig
ovEAGdg <- ovEAG
palpot <- colorFactor(palette = col,  domain = ovEAGdg$potentieft)

leaflet() %>%
  addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.05, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = ovEAGdg, layerId = ovEAGdg$GAFIDENT,
    popup= paste("EAG naam", ovEAGdg$GAFNAAM.x, 'potentie ',ovEAGdg$potentie, 'doelgat ', ovEAGdg$doelgat),
    stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
    fill=T, fillColor = ~palpot(ovEAGdg$potentieft), fillOpacity = 0.5) %>%
  addLegend("bottomright", colors=col, labels=labelspot, title = "Potentie")%>%
  addProviderTiles("Esri.WorldGrayCanvas")

#prio tabel gebieden maken -----------------
gEAG$prio1 <- 0;gEAG$prio1[gEAG$doelgat >= 0.1] <- 1;gEAG$prio1[gEAG$doelgat >= 0.2] <- 2
gEAG$prio2 <- 0;gEAG$prio2[gEAG$potentie >= 0.5] <- 1;gEAG$prio2[gEAG$potentie >= 0.6] <- 2
gEAG$prio3 <- 0;gEAG$prio3[gEAG$GAFIDENT %in% plaseag] <- 1 
gEAG$prio4 <-0;gEAG$prio4[gEAG$GAFIDENT %in% agEAG$GAFIDENT] <- 1 

# NB doelgat is nu nergens een voorwaarde
gEAG$priotot <- gEAG$prio1 + gEAG$prio2 + gEAG$prio3 #+ gEAG$prio4 # methode 1 zonder 4, 2 met 4 erbij

# selectie EAGtype met prioritering ----------------------
# prio <- gEAG[gEAG$prio4 > 0.9,] # methode 1, alleen agrarische EAGs
# prio <- gEAG[gEAG$prio4 > 0.9 & gEAG$doelgat > 0.1,] # methode 1b, alleen agrarische EAGs met groot doelgat
prio <- gEAG[gEAG$prio4 > 0.9| (gEAG$priotot > 3 & gEAG$relagr > 0.1 & gEAG$agropptot > 100000),] # methode 1a, agrarisch + bonus 
# prio <- gEAG[gEAG$relagr > 0.1 & gEAG$aggopptot > 100000,] # methode 2, agrarisch als score 
#stedelijk prio
prio <- gEAG[gEAG$GAFIDENT %in% stedEAG$GAFIDENT,]
#overig prio
prio <- gEAG[gEAG$GAFIDENT %in% ovEAG$GAFIDENT,]
prio <- prio[!is.na(prio$GAFIDENT),] 

binpal <- colorBin("Blues", prio$priotot, bins = 5, pretty = TRUE)

leaflet() %>%
  addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.05, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = prio, layerId = prio$GAFIDENT,
    popup= paste("EAG naam", prio$GAFNAAM, 'potentie ',prio$potentie, 'doelgat ', prio$doelgat, 'priotot ', prio$priotot),
    stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
    fill=T, fillColor = ~binpal(prio$priotot), fillOpacity = 0.8) %>%
  addLegend(pal = binpal, values = prio$priotot, labels = c('0','1','2','3','4','5','6'), position = "bottomright") %>%
  addProviderTiles("Esri.WorldGrayCanvas") 

# export ----------------
priot <- as.data.table(prio)
priot <-priot[, ':='(geometry = NULL)]
write.table(priot, paste0("output/prio_agr_methode1a", Sys.Date(),".csv"), sep=";", dec=".", row.names=F)
st_write(prio[,c( "GAFIDENT","GAFNAAM","OWMTYPE","OppEAG","OppLand","OppWater","agropptot","doelgat", "potentie", "priotot")], paste0("output/prio_agr_methode1a", Sys.Date(),".gpkg"))
st_write(prio[,c( "GAFIDENT","GAFNAAM","OWMTYPE","OppEAG","OppLand","OppWater","agropptot","doelgat", "potentie", "priotot")], paste0("output/prio_agr_methode1a", Sys.Date(),".shp"))

```

```{r waterdiepte, include=FALSE, eval = FALSE}
prio <- gEAG[gEAG$prio4 > 0.9| (gEAG$priotot > 3 & gEAG$relagr > 0.1 & gEAG$agropptot > 100000),] # methode 1a, agrarisch + bonus 
prio1 <- prio[prio$priotot > 2,] # score 3, 4, 5

#waterdiepte per eag # [grepl('3360', hybi$EAGIDENT),] [grepl('3360|3302', hybi$EAGIDENT) ,]
ppr_dieptekaart(hybi[hybi$watertype %in% c('M1a','M1b','M8',"M10","M3") & hybi$jaar > 2016,], agEAG, gbrpAGV, kansrijk = FALSE, handelperspectief = FALSE)
#percentage kansrijke locaties: locaties waar waterdiepte < 0.35 en submerse bedekking < 30
ppr_dieptekaart(hybi[hybi$watertype %in% c('M1a','M1b','M8',"M10","M3") & hybi$jaar > 2016,], agEAG,gbrpAGV, kansrijk = TRUE, handelperspectief = FALSE)
#percentage kansrijke locaties agrarisch, niet prioritair: locaties waar waterdiepte < 0.35 en submerse bedekking < 30 en vaste bodem dieper dan 0.35 cm
ppr_dieptekaart(hybi[hybi$watertype %in% c('M1a','M1b','M8',"M10","M3") & hybi$jaar > 2016,], gebieden = prio1,gbrpAGV,kansrijk = TRUE, handelperspectief = TRUE)

```

```{r relatieve slootlengte, include=FALSE, eval = FALSE}
agEAG$relsloot <- agEAG$OmtrekWater/agEAG$OppWater
binpal2 <- colorBin("Blues", agEAG$relsloot, 4, pretty = FALSE)

leaflet() %>%
  addPolygons(data = gbrpAGV,popup= paste("waterlichaamnaam", gbrpAGV$GAFNAAM), stroke = F, color= 'green',
              opacity=0.8, weight = 0.6, smoothFactor = 0.8,
              fill=T, fillColor = ~binpal(gbrpAGV$prio), fillOpacity = 0.9) %>%
  addPolygons(data = agEAG[agEAG$OWMTYPE_WBP %in% c('M8',"M10"),], layerId = agEAG$GAFIDENT,popup= paste("EAG naam", agEAG$GAFNAAM.x),
              stroke = FALSE, color= NULL, opacity= 0.5, weight = 0.5, smoothFactor = 0.8,
              fill=T, fillColor = ~binpal2(agEAG$relsloot), fillOpacity = 0.6) %>%
  addLegend(data= agEAG, pal = binpal2, values = ~relsloot, position = "bottomright") %>%
  addProviderTiles("Esri.WorldGrayCanvas") 



```

```{r ecologisch schonen, include=FALSE, eval = FALSE}
prio <- gEAG[gEAG$prio4 > 0.9| (gEAG$priotot > 3 & gEAG$relagr > 0.1 & gEAG$agropptot > 100000),] # methode 1a, agrarisch + bonus 
prio1 <- prio[prio$priotot > 2,]

krw2soorten <- krw2[krw2$GHPR %in% "Soortensamenstelling macrofyten Waterplanten", ] # alleen maatlat flora
prio <- merge(prio, krw2soorten[!is.na(krw2soorten$EAGIDENT),c('EAGIDENT','EKR')], by.x = 'GAFIDENT', by.y ='EAGIDENT', all.x = TRUE, all.y = FALSE)
prio$EKRsoort <- prio$EKR.y
esteag <- esteag[,yearid := frank(-jaar, ties.method = 'dense'), by = 'locatie.EAG'][yearid <= 1]
prio <- merge(prio, esteag[!is.na(esteag$locatie.EAG),c('locatie.EAG','KROOS',"doorz_diep",'diepte', 'talud')], by.x = 'GAFIDENT', by.y ='locatie.EAG', all.x = TRUE, all.y = FALSE) 

schonen <- prio[prio$KROOS < 15 & prio$EKRsoort > 0.55 ,]#& prio$diepte > 0.35
binpal <- colorBin("Blues", schonen$talud, bins = 7, pretty = TRUE)

leaflet() %>%
 addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.05, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = schonen, layerId = schonen$GAFIDENT,
    popup= paste("EAG naam", schonen$GAFNAAM.x, 'potentie ',schonen$potentie, 'doelgat ', schonen$doelgat, 'talud ', schonen$talud),
    stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
    fill=T, fillColor = ~binpal(schonen$talud), fillOpacity = 0.8) %>%
  addLegend(pal = binpal, values = schonen$talud, labels = c('0','1','2','3','4','5','6'), position = "bottomright") %>%
  addProviderTiles("Esri.WorldGrayCanvas") 

```

```{r lichtklimaat, include=FALSE, eval = FALSE}
prio <- gEAG[gEAG$prio4 > 0.9,] # methode 1, alleen agrarische EAGs

prio <- merge(prio, esteag[!is.na(esteag$locatie.EAG),c('locatie.EAG','KROOS',"doorz_diep",'diepte')], by.x = 'GAFIDENT', by.y ='locatie.EAG', all.x = TRUE, all.y = FALSE) 

binpal <- colorBin("Blues", prio$doorz_diep, bins = 7, pretty = TRUE)

leaflet() %>%
 addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.05, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = prio, layerId = prio$GAFIDENT,
    popup= paste("EAG naam", prio$GAFNAAM.x, 'potentie ',prio$potentie, 'doelgat ', prio$doelgat, 'priotot ', prio$priotot, "dooerzicht/diepte ", prio$doorz_diep),
    stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
    fill=T, fillColor = ~binpal(prio$doorz_diep), fillOpacity = 0.8) %>%
  addLegend(pal = binpal, values = prio$doorz_diep, position = "bottomright") %>%
  addProviderTiles("Esri.WorldGrayCanvas") 

```

```{r waterbodem, include=FALSE, eval = FALSE}
prio <- gEAG[gEAG$prio4 > 0.9,] # methode 1, alleen agrarische EAGs
#stedelijk prio
prio <- gEAG[gEAG$GAFIDENT %in% stedEAG$GAFIDENT,]
#overig prio
prio <- gEAG[gEAG$GAFIDENT %in% ovEAG$GAFIDENT,]
pvskp <- ppr_pmaps(dat, Overzicht_kp, hybi, nomogram, pYEAR = FALSE)
misEAG <- gEAG[pvskp$GAF[is.na(pvskp$EAG)] %in% gEAG$gaf, c('GAFIDENT','gaf')]
misEAG <- misEAG[!pvskp$EAG %in% misEAG$GAFIDENT,]

pvskp <- merge(pvskp, misEAG, by.x = "GAF", by.y = "gaf", all = TRUE)
pvskp$GAFIDENT[!is.na(pvskp$EAG)] <- pvskp$EAG[!is.na(pvskp$EAG)]

prio <- prio[!is.na(prio$GAFIDENT),]
prio <- merge(prio, bod.sel.wide.eag, by.x = 'GAFIDENT', by.y ='EAGIDENT', all.x = TRUE, all.y = FALSE) 

# bodem probleem waar PvskP < 1, want anders moet belasting eerst worden aangepakt
prio <- prio[prio$PvskPDitch < 1,]
binpal <- colorBin("Blues", prio$doorz_diep, bins = 7, pretty = TRUE)

leaflet() %>%
 addPolygons(data = gbrpAGV,
              stroke = T, color= 'green', opacity=0.05, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3) %>%
  addPolygons(data = prio, layerId = prio$GAFIDENT,
    popup= paste("EAG naam", prio$GAFNAAM.x, 'potentie ',prio$potentie, 'doelgat ', prio$doelgat, 'priotot ', prio$priotot, "dooerzicht/diepte ", prio$doorz_diep),
    stroke = FALSE, color= NULL, opacity= 0.8, weight = 0.5, smoothFactor = 0.8,
    fill=T, fillColor = ~binpal(prio$doorz_diep), fillOpacity = 0.8) %>%
  addLegend(pal = binpal, values = prio$doorz_diep, position = "bottomright") %>%
  addProviderTiles("Esri.WorldGrayCanvas") 

```

```{r trendanalyse, include=FALSE, eval = FALSE}

plottrendEAG(trendekreag, gEAG, maatlat = "Overige waterflora-kwaliteit")
plottrendEAG(trendekreag, gEAG, maatlat = "Soortensamenstelling macrofyten")
plottrendEAG(trendekreag, gEAG, maatlat = "Macrofauna-kwaliteit")

#plot om na te kijken per gebied
ggplot(data= EKRset[EKRset$EAGIDENT == '2000-EAG-1' & EKRset$facet_wrap_code == 'Fytoplankton',], aes(x=datum, y=Numeriekewaarde, col = GHPR, group = GHPR))+
    geom_point()+
    geom_smooth(method = "lm")+
  facet_grid(.~GHPR)+
    ylab('')+xlab('')+
    ggtitle("")+
    theme_minimal()+
    theme(
      strip.background = element_blank(),
      strip.text.x = element_text(size = 7), #waardebepmethode
      strip.text.y = element_text(size = 2), #level
      axis.text.x = element_text(size= 5, angle=90), #jaar
      axis.text.y = element_text(size= 5),
      axis.ticks =  element_line(colour = "black"),
      panel.background = element_blank(),
      plot.background = element_blank(),
      legend.title = element_text(size = 7),
      legend.text  = element_text(size = 6),
      legend.key.size = unit(0.9, "lines"),
      legend.position = "right")



```

```{r monitoring, include=FALSE, eval = FALSE}
library(readxl)
overzicht_strategy <- read_excel("C:/Users/laura/SPRINGG/NMISite - Documents/Projecten/O 1800 - O 1900/1889.N.22 Inhuuropdracht Waternet LM/01 data/MNBT_overzichten/overzicht_strategy.xlsx")

# aantal loc per jaar per kwaliteitselement
setDT(hybi)
hybi[,profieloverzicht := paste0(hybi$analysecode, hybi$compartiment)]
hybi[hybi$fewsparameter == 'PTN_BEDKG_%_grensWTP', profieloverzicht := 'PTN_DT']
hybi$profieloverzicht[hybi$analysecode == 'VSLC'] <- paste0(hybi$analysecode, hybi$veldapparaat)[hybi$analysecode == 'VSLC']


hybi[!(hybi$locatiecode == 'NKP147' & hybi$jaar %in% c('2020','2021')), maxjaar := max(jaar), by = c('EAGIDENT','analysecode','compartiment')]

nlochybi <- dcast(hybi,EAGIDENT+locatie.KRWmeetpuntlocatie +profieloverzicht+locatie.KRW.watertype+compartiment+maxjaar~jaar, value.var = 'locatiecode', fun.aggregate = uniqueN)
write.table(nlochybi, paste0("output/nlochybi_", Sys.Date(),".csv"), sep=";", dec=".", row.names=F)

EKRset[, maxjaar := max(jaar), by = c('EAGIDENT','GHPR')]
nlocfyto <- dcast(EKRset,EAGIDENT+OWMIDENT +GHPR+level+maxjaar~jaar, value.var = 'CODE', fun.aggregate = uniqueN)
write.table(nlocfyto, paste0("output/nlocfyto_", Sys.Date(),".csv"), sep=";", dec=".", row.names=F)

# locatiecodes selecteren
setorder(hybi,EAGIDENT,analysecode,compartiment,-jaar)
# add year number (given ordered set), and take only the most recent years
# change EAG NKP147 omdat dit enige punt is in lastptn
d1 <- hybi[!(hybi$locatiecode == 'NKP147' & hybi$jaar %in% c('2020','2021')),maxjaar := max(jaar), by = c('EAGIDENT','analysecode','compartiment')][maxjaar == jaar]
d1 <- d1[!(d1$fewsparameter == 'PTN_BEDKG_%' & d1$analysecode == 'VSLC'),]
dp <- d1[d1$fewsparameter == 'PTN_BEDKG_%_grensWTP',]
dp <- dp[,c('EAGIDENT','analysecode','compartiment','locatiecode','jaar','maxjaar','locatie.x','locatie.y','veldapparaat'), ]
dp <- unique(dp)
d1 <- d1[,c('EAGIDENT','analysecode','compartiment','locatiecode','jaar','maxjaar','locatie.x','locatie.y','veldapparaat'), ]
d1 <- unique(d1)
write.table(d1, paste0("output/lastlochybi_", Sys.Date(),".csv"), sep=";", dec=".", row.names=F)

locPTN <- merge(overzicht_strategy[overzicht_strategy$PTN > 0 & !is.na(overzicht_strategy$PTN),], d1[d1$analysecode == "PTN",], by.x = c('GAFIDENT'),by.y = c('EAGIDENT'), all.x = TRUE)
locMEA <- merge(overzicht_strategy[overzicht_strategy$MEA > 0 & !is.na(overzicht_strategy$MEA),], d1[d1$analysecode == "MEA",], by.x = c('GAFIDENT'),by.y = c('EAGIDENT'), all.x = TRUE)
locVIS <- merge(overzicht_strategy[overzicht_strategy$VSLC > 0 & !is.na(overzicht_strategy$VSLC),], d1[d1$analysecode == "VSLC",], by.x = c('GAFIDENT'),by.y = c('EAGIDENT'), all.x = TRUE)

locPTN$Profiel[locPTN$compartiment == 'EZ'& locPTN$watertype %in% c("M3", "M1a","M1b","M30","M6a","M7b","M6b","M7a","M8", "M10")] <- 'MACFTLVEZ'
locPTN$Profiel[locPTN$compartiment == 'OR'& locPTN$watertype %in% c("M3", "M1a","M1b","M30","M6a","M7b","M6b","M7a","M8", "M10")] <- 'MACFTLVOR'
locPTN$Profiel[locPTN$compartiment == 'EZ'& locPTN$watertype %in% c('M20','M27','M25',"M14", 'M11')] <- 'MACFTMPEZ'
locPTN$Profiel[locPTN$compartiment == 'OR'& locPTN$watertype %in% c('M20','M27','M25',"M14", 'M11')] <- 'MACFTMPOR'
locPTN$Profiel[locPTN$compartiment == 'OW'& locPTN$watertype %in% c('M20','M27','M25',"M14", 'M11')] <- 'MACFTMPOW'
locPTN$Profiel[locPTN$locatiecode %in% dp$locatiecode] <- 'MACFTMPOW_MACFTMPDPTTJTN'
locPTN$Profiel[is.na(locPTN$Profiel)] <- 'MACFT??'; locPTN$analysecode[locPTN$Profiel == 'MACFT??']<- 'PTN'
locMEA$Profiel <-'MACEVMLTHBTT'; locMEA$analysecode <- 'MEA'
locVIS$Profiel <- locVIS$veldapparaat; locVIS$Profiel[is.na(locVIS$Profiel)] <- 'VSLC??'; locVIS$analysecode[locVIS$Profiel== 'VSLC??'] <- 'VSLC'

'nietPTN' -> locVIS$PTN[!(locVIS$locatiecode %in% d1$locatiecode[d1$analysecode == 'PTN'])]
'nietPTN' -> locMEA$PTN[!(locMEA$locatiecode %in% d1$locatiecode[d1$analysecode == 'PTN'])]

# dubbele locatie vanwege veldapparaat
hybi2023 <- rbind(locVIS, locMEA, locPTN)
'welPTN' -> hybi2023$PTN[!hybi2023$PTN == 'nietPTN']
NULL -> hybi2023[,c('MEA','VSLC','FPA','ZPT')]
hybi2023 <- unique(hybi2023[,c("GAFIDENT","GAFNAAM","KRW_SGBP3","SGBP3_NAAM","watertype","PTN","analysecode","compartiment","locatiecode","maxjaar","locatie.x","locatie.y","Profiel")])
write.table(hybi2023, paste0("output/hybi2023_", Sys.Date(),".csv"), sep=";", dec=".", row.names=F)

# visualiseer op kaart
# te bemonsteren EAGs
EAGstrat <- merge(gEAG, overzicht_strategy, by = 'GAFIDENT', all.x =TRUE)
ptnstrat <- EAGstrat[EAGstrat$PTN > 0 & !is.na(EAGstrat$PTN), ]
meastrat <- EAGstrat[EAGstrat$MEA > 0 & !is.na(EAGstrat$MEA), ]
visstrat <- EAGstrat[EAGstrat$VSLC > 0 & !is.na(EAGstrat$VSLC), ]
# te bemonsteren locaties
hybi2023 <- hybi2023[!is.na(hybi2023$locatie.x),]
hybi2023 <- st_transform(st_as_sf(hybi2023,coords = c("locatie.x","locatie.y"),crs = 28992),4326)
plantenall <- st_transform(st_as_sf(d1[d1$analysecode == 'PTN',],coords = c("locatie.x","locatie.y"),crs = 28992),4326)
mcftlvez <- hybi2023[hybi2023$Profiel == 'MACFTLVEZ',]
mcftlvor <- hybi2023[hybi2023$Profiel == 'MACFTLVOR',]
mcftmpez <- hybi2023[hybi2023$Profiel == 'MACFTMPEZ',]
mcftmpow <- hybi2023[hybi2023$Profiel == 'MACFTMPOW',]
mcftmpor <- hybi2023[hybi2023$Profiel == 'MACFTMPOR',]
mcftmpdiepte <- hybi2023[hybi2023$Profiel == 'MACFTMPOW_MACFTMPDPTTJTN',]
mea <- hybi2023[hybi2023$Profiel == 'MACEVMLTHBTT',]
viselectro <- hybi2023[hybi2023$Profiel %in% c("Elektrisch schepnet met keernetten", "Elektrisch schepnet" ),]
viszegen <- hybi2023[hybi2023$Profiel %in% c("Zegen" ),]
viskuil <- hybi2023[hybi2023$Profiel %in% c("Stortkuil" ),]
meanietptn <- hybi2023[hybi2023$Profiel == 'MACEVMLTHBTT' & hybi2023$PTN == 'nietPTN',]
visnietptn <- hybi2023[hybi2023$analysecode == 'VSLC' & hybi2023$PTN == 'nietPTN',]

leaflet() %>%
  addPolygons(data = ptnstrat,
              stroke = T, color= 'black', opacity=0.9, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3, group = 'mcft', 
              popup = paste0('eag ',ptnstrat$GAFIDENT,' eagnaam ',ptnstrat$GAFNAAM.x)) %>%
  addPolygons(data = meastrat,
              stroke = T, color= 'black', opacity=0.9, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3, group = 'mea',
              popup = paste0('eag ',meastrat$GAFIDENT,' eagnaam ',meastrat$GAFNAAM.x)) %>%
  addPolygons(data = visstrat,
              stroke = T, color= 'black', opacity=0.9, weight = 0.2, smoothFactor = 0.8,
              fill=T, fillColor = 'green', fillOpacity = 0.3, group = 'vis',
              popup = paste0('eag ',visstrat$GAFIDENT,' eagnaam ',visstrat$GAFNAAM.x)) %>%
  addCircles(data = mcftlvez, radius= 10, color= 'green', fillOpacity = 0.8, group = 'mcftlvez',
             label = c(as.character(mcftlvez$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE,
                                                                                        textsize = '8px', permanent = TRUE)) %>%
  addCircles(data = mcftlvor, radius= 10, color= 'green', fillOpacity = 0.8, group = 'mcftlvor',
             label = c(as.character(mcftlvor$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE,
                                                                                        textsize = '8px', permanent = TRUE)) %>%
  addCircles(data = mcftmpor, radius= 10, color= 'green', fillOpacity = 0.8, group = 'mcftmpor',
             label = c(as.character(mcftmpor$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE, 
                                                                                        textsize = '8px', permanent = TRUE)) %>%
  addCircles(data = mcftmpow, radius= 10, color= 'green', fillOpacity = 0.8, group = 'mcftmpow',
             label = c(as.character(mcftmpow$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE, 
                                                                                        textsize = '8px', permanent = TRUE)) %>%
  addCircles(data = mea, radius= 10, color= 'green', fillOpacity = 0.8, group = 'mealoc',
             label = c(as.character(mea$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE,
                                                                                   textsize = '8px', permanent = TRUE)) %>%
  addCircles(data = mcftmpez, radius= 10, color= 'green', fillOpacity = 0.8, group = 'mcftmpez',
             label = c(as.character(mcftmpez$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE,
                                                                                        textsize = '8px', permanent = TRUE)) %>%
  addCircles(data = mcftmpdiepte, radius= 10, color= 'green', fillOpacity = 0.8, group = 'mcftmpdiepte',
             label = c(as.character(mcftmpdiepte$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE,
                                                                                        textsize = '8px', permanent = TRUE)) %>%
  addCircles(data = viselectro, radius= 10, color= 'green', fillOpacity = 0.8, group = 'viselectro',
             label = c(as.character(viselectro$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE,
                                                                                          textsize = '8px', permanent = TRUE)) %>%
  addCircles(data = viszegen, radius= 10, color= 'green', fillOpacity = 0.8, group = 'viszegen',
             label = c(as.character(viszegen$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE,
                                                                                        textsize = '8px', permanent = TRUE)) %>%
  addCircles(data = viskuil, radius= 10, color= 'green', fillOpacity = 0.8, group = 'viskuil',
             label = c(as.character(viskuil$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE,
                                                                                       textsize = '8px', permanent = TRUE)) %>%
  addCircles(data = visnietptn, radius= 10, color= 'red', fillOpacity = 0.8, group = 'visnietptn',
             label = c(as.character(visnietptn$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE,
                                                                                        textsize = '8px', permanent = TRUE)) %>%
  addCircles(data = meanietptn, radius= 10, color= 'red', fillOpacity = 0.8, group = 'meanietptn',
             label = c(as.character(meanietptn$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE,
                                                                                        textsize = '8px', permanent = TRUE)) %>%
  addCircles(data = plantenall, radius= 10, color= 'yellow', fillOpacity = 0.8, group = 'plantenall',
             label = c(as.character(plantenall$locatiecode)), labelOptions = labelOptions(interactive = TRUE, noHide = FALSE,
                                                                                        textsize = '8px', permanent = FALSE)) %>%
                                                                                        
                                                                                         
  addLayersControl(
    baseGroups=c( "mcft",'mea', 'vis'),
    overlayGroups=c("mcftlvez", "mcftlvor", "mcftmpor",
                    "mcftmpow","mcftmpez",'mcftmpdiepte','mealoc','viselectro','viszegen','viskuil','visnietptn','meanietptn','plantenall'),
    position = "bottomleft",
    options = layersControlOptions(collapsed = TRUE))%>%
  addProviderTiles("Esri.WorldGrayCanvas") 

## Overzicht metingen per jaar
dcast(hybi)
  

```

