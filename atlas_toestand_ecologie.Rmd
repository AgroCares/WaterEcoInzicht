---
title: "WaterEcoInzicht"
subtitle: "Visualisaties van de ontwikkelingen in ecologische waterkwaliteit in het beheergebied van waterschap Amstel, Gooi en Vecht."
author: "Laura Moria"
date: "`r Sys.Date()`"
always_allow_html: yes
delete_merged_file: TRUE
site: bookdown::bookdown_site
css: css/factsheet.css
output:
  bookdown::gitbook:
    lib_dir: assets
    split_by: none
    config:
      toolbar:
        position: static
  bookdown::pdf_book:
    keep_tex: true
  bookdown::html_book:
    cache: false
    css: toc.css
documentclass: book
editor_options: 
  chunk_output_type: inline
---
  
```{r global, include = FALSE}
# voor hosten bij bookdown
# LET OP KRW_SGBP3 wordt KRW_NAAM
# Naam Ov waterflora not replaces from Ov. Waterflora 2 waterflora
# "Warning: there are duplicate records of EKR for some areas in the data table!"

#  Settings-------------------------------------------------------
rm(list=ls())                               #maakt geheugen leeg voor aanvang
chooseCRANmirror(graphics=FALSE, ind=1)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
memory.limit(size = 50000)

# Load packages and functions-------------------------------------
library(scatterpie); library(ggnewscale); library(tmap); library(cowplot); library(ggspatial) # voor map pie figuur
library(flextable);library(officer) # voor tabel toestand trend
library(knitr)# weergave figuur met inlcude grapics
library(purrr); library(tidyr); library(broom); library(readxl);library(rpivotTable);library(kableExtra)
library(dplyr);library(plyr);library(sp);library(plotly);library(sf);library(zoo)
library(leaflet);library(RColorBrewer) #voor kaarten met kleurenlegenda
library(ggplot2);library(data.table)
library(manipulateWidget)#combineWidget
library(htmlwidgets)#savewidget

source("./scripts/fun_map_pie.R")
source('./scripts/ppr_funs_waterecoinzicht.R')

# other settings
col <- c('3'="blue",'4'="green",'5'="yellow",'6'="orange",'7'="red")
labels <- c('3'="0.8-1",'4'="0.6-0.8",'5'="0.4-0.6",'6'="0.2-0.4",'7'="0-0.2")

```

```{r data, include = FALSE}

## data voor kaart ----------
gEAG <- st_read("./data/EAG_20220809.gpkg") %>% st_transform(4326)
gEAG$watertype <- NULL
EAG <- st_read("./data/EAG_20220809.gpkg") %>% st_transform(28992)
gKRW <- st_read("./data/WBPKRW20200525.gpkg")%>% st_transform(4326)
KRW <- st_read("./data/WBPKRW20200525.gpkg")%>% st_transform(28992)
## aanvullende eag data, krwwatertype niet overal ingevuld en stedelijk landelijk voor EST
## let op: als nieuwe EAG (gEAG) dan deze tabel aanpassen en aanvullen
eag_wl <- fread('./input/gebiedsinfo/EAG_Opp_kenmerken_20220811.csv')
eag_wl <- eag_wl[is.na(eag_wl$Einddatum),]

# domain TWN codes, addiotional information on taxa
TWNev <- read_excel('./input/TwnList_2019-07-19.xlsx')

# data hybi
hybi <- readRDS('./data/hybi.rds') %>% as.data.table()

# KRW toetsgegevens
EKRset <- readRDS('./data/krw/EKRset.rds') %>% as.data.table()
trendekreag <- readRDS('./data/krw/trendekreag.rds')  %>% as.data.table() #alle trends per EAG
trendekreag$facet_wrap_code <- gsub("Ov. waterflora", "Waterflora", trendekreag$facet_wrap_code)
ekrtrend <- readRDS('./data/krw/ekrtrend.rds') %>% as.data.table() #alleen hoofd, gewogen (dus niet per meetlocatie)
ekrtrend$facet_wrap_code <- gsub("Ov. waterflora", "Waterflora", ekrtrend$facet_wrap_code)
ekrtrendeag <- readRDS('./data/krw/ekrtrendeag.rds')  %>% as.data.table() #alleen hoofdmaatlat
ekrtrendeag$facet_wrap_code <- gsub("Ov. waterflora", "Waterflora", ekrtrendeag$facet_wrap_code)

EKRlijst <- readRDS('./data/krw/EKRlijstKRW2023.rds')
tabset <- readRDS('./data/krw/ekr_scores.rds') %>% as.data.table()
tabsetwbp1 <- readRDS('./data/krw/ekr_scores_wbp1.rds') %>% as.data.table()
tabsetwbp2 <- readRDS('./data/krw/ekr_scores_wbp2.rds') %>% as.data.table()
tabsetwbp3 <- readRDS('./data/krw/ekr_scores_wbp3.rds') %>% as.data.table()

# aggregated waterbody scores
ekr_scores1 <- readRDS('./data/krw/ekr_scores1.rds') %>% as.data.table()
ekr_scores2 <- readRDS('./data/krw/ekr_scores2.rds') %>% as.data.table()

# data water quality
wq <- readRDS('./data/wq.rds') %>% as.data.table()

# data P loads
pvskp <- readRDS('./data/pvskp.rds') %>% as.data.table()

```

# Inleiding

In deze rapportage zijn de actuele stand van zaken en de recente ontwikkelingen binnen het aquatische ecosysteem in de regio Amstel, Gooi en Vechtstreek samengebracht. Deze informatie wordt gepresenteerd in de vorm van een atlas met thematische kaarten. Deze kaarten visualiseren de ecologische doelstellingen van het Amstel, Gooi en Vechtgebied, de huidige ecologische status en hoe deze in de loop der tijd veranderd is.

De beoordeling van de ecologische toestand vormt de basis voor watersysteemanalyses. Deze analyses zijn essentieel voor verschillende KRW-gerelateerde processen, zoals gebiedsbeheer, operationele planning en de evaluatie van genomen maatregelen. Bovendien wordt de ecologische conditie van individuele waterlichamen of deelgebieden gerapporteerd in de KRW-factsheets, die beschikbaar zijn op de website www.waterkwaliteitsportaal.nl. Deze informatie wordt ook opgenomen in het waterbeheerplan van het AGV (Amstel, Gooi en Vecht) gebied.

# Ecologische waterkwaliteit in beeld

Alle beschikbare meetgegevens van hydrobiologische kwaliteitselementen zijn getoetst aan landelijke beoordelingsmethodiek voor sloten, kanalen (Omschrijving MEP en maatlatten voor sloten en kanalen, STOWA rapport 2012-34) en meren (Referenties en maatlatten voor natuurlijke watertypen voor de Kaderrichtlijn Water, STOWA rapport 2012-31). Het resultaat hiervan is een getal uitgedrukt met behulp van het begrip Ecologische Kwaliteitsratio (EKR score). Deze EKR scores worden de ecologische toestand genoemd. De EKR is de eenheid waarin de feitelijke en de gewenste ecologische toestand van een waterlichaam kan worden uitgedrukt. Een EKR kan worden bepaald voor elk de vier biologische kwaliteitselementen: fytoplankton (algen), waterplanten (overige waterflora), macrofauna (met het blote oog zichtbare ongewervelde dieren, zoals slakken en libellen) en vissen. De EKR heeft daarbij altijd een waarde tussen 0 en 1, waarbij de waarde 1 overeen komt met de natuurlijke referentie. Een score van 1 staat dus voor een maximaal haalbare ecologische kwaliteit in water dat niet door menselijk toedoen wordt verstoord. Een score van 0.6 staat voor een haalbare ecologische kwaliteit in water dat door de mens is gemaakt bij het winnen van turf en zand. Of water dat wordt gebruikt om in te varen of als afvoer om het land en de straat droog te houden.

Bij het bepalen van ecologische doelen is rekening gehouden met (natuurlijke) fysieke randvoorwaarden, zoals de achtergrondbelasting van nutriënten (wanneer aanwezig). Het gaat hierbij bijvoorbeeld om fosfaatrijke kwel in het westen van het land. Dit betekent dat het ecologisch doel minder hoog is in gebieden met een bepaalde achtergrondbelasting voor stikstof en/of fosfaat dan in gebieden zonder die belasting.

De toestand van het water wordt jaarlijks beoordeelt op basis van de van toepassing zijn de kwaliteitselementen. Het oordeel wordt uitgedrukt op basis van een door de KRW voorgeschreven onderverdeling in ecologische toestandsklassen. De ecologische toestand bestaat weer uit verschillende deelbeoordelingen. Deze deelbeoordeling gebeurt op basis van maatlatten. Een maatlat beschrijft de toestand van een waterlichaam per kwaliteitselement in een getal uitgedrukt met behulp van het begrip Ecologische Kwaliteitsratio (EKR score). Voor elk biologisch kwaliteitselement zijn één of meerdere deelmaatlatten onderscheiden op basis van de soortensamenstelling en de (relatieve) aanwezigheid van soorten, en voor vis de leeftijdsopbouw. 

Onderdeel van het beoordelen is het toetsen. Hierbij wordt bepaald hoe een toetswaarde zich verhoudt tot een norm of KRW-doel (GEP). Dat resulteert in een oordeel. In onderstaande figuren staan de berkende EKR scores, doelen en de oordelen die daaruit volgen per biologisch kwaliteitselement weergegeven zodat zichtbaar wordt hoe het oordeel is opgebouwd. In KRW waterlichamen wordt een oordeel bepaald voor elk van de 4 biologische kwaliteitselementen en voor de ondersteunende parameters. In het overig water wordt standaard alleen een oordeel bepaald voor het kwaliteitselement waterplanten (overige waterflora). 

## Overzicht oordelen per KRW waterlichaam

```{r, eval = FALSE, warning = FALSE, message = FALSE, include = FALSE}
# # Threshold values of EKR for 4 levels, separately defined for 4 EKR type.
# #'Dimension should be 4 rows (= EKR type) x 5 columns (= 5 breaks for 4 levels)
# ekr_breaks = rbind(c(0, 0.2, 0.4, 0.6, 1), #"Fytoplankton
#                     c(0, 0.2, 0.4, 0.6, 1), #Overige waterflora
#                     c(0, 0.2, 0.4, 0.6, 1), #Macrofauna
#                     c(0, 0.2, 0.4, 0.6, 1)) #Vis
# 
# 
# # Make a map with pie chart (based on the numerical variable "EKR") and save as JPEG
# gp_c <- draw_map(KRW, ekr_scores1, bkpl = EAG,
#                  col_ekr = "EKR", ekr_fac = FALSE,
#                  col_area_sf = "OWMIDENT", col_area_dt = "KRW_SGBP3",
#                  ekr_breaks = ekr_breaks,
#                  filename = "map_EKR_waterlichaam.jpg")

# Make a map with pie chart (based on the catagorical variable "oordeel") and save as JPEG
suppressMessages(map <- draw_map(pl = KRW, dt = ekr_scores1[ekr_scores1$level == 1,], bkpl = EAG,
                                 col_ekr = "oordeel_2022", ekr_fac = TRUE, 
                                 col_area_sf = "OWMIDENT", col_area_dt = "KRW_SGBP3",
                                 filename = "map_oordeel_waterlichaam.jpg"))
```

```{r mappie, echo=FALSE, fig.cap= "Biologische oordelen van de vier biologische kwaliteitselementen in KRW waterlichamen", message=FALSE, warning = FALSE, fig.height = 8, fig.width = 12}

include_graphics('map_oordeel_waterlichaam.jpg')
```

## Overzicht oordelen per Ecologisch analysegebied

```{r kaartenekroordeeldoelmcft1, fig.cap = 'Overzicht van oordelen, EKR scores en doelen op de maatlat overige waterflora.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}

#krw <-
KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Ov. waterflora" ,], 
          maatlat = "2V1 Overige waterflora", param = "oordeel")

# saveWidget(krw, "waterflora.html", selfcontained = FALSE)
# webshot("waterflora.html", file = "waterflora.png")

```

In het overig water wordt standaard alleen een oordeel bepaald voor het kwaliteitselement waterplanten (overige waterflora). 

## Overzicht ontwikkeling ecologische kwaliteit

De ontwikkeling in ecologische kwaliteit kan op verschillende manieren worden verbeeld. Voor de jaarlijkse rapportage over de stand van zaken wordt het verschil tussen de kwaliteit van waterplanten in de perioden van het eerste en tweede stroomgebiedbeheerplan gebruikt. Deze planperioden zijn relevant om de toestand te kunnen relateren aan de maatregelen die in deze perioden zijn uitgevoerd. In de formele KRW-factsheets wordt de eerst gerapporteerde toestand (toestand 2009), de laatst gerapporteerde toestand in de eerste planperiode (toestand 2015), de laatst gerapporteerde toestand in de tweede planperiode (toestand 2021) en de meest recente toestand weergegeven. Op het moment dat de toestand wordt bepaald en gerapporteerd zijn er nog geen gegevens beschikbaar die zijn verzameld in hetzelfde jaar, daarom zijn de gegevens die worden gebruikt altijd een jaar ouder dan het toetsjaar. Voor de toestand die in 2015 is bepaald is dus gebruik gemaakt data van de laatste drie meetjaren die is verzameld tussen 2006 en 2014. In de kaarten hieronder zijn dezelfde perioden gebruikt als voor de formele rapportage van de toestand 2015, 2021 en 2023. In de formele toetsing worden de laatste drie meetjaren gebruikt om te komen tot een periodeoordeel en de gebruikte gegevens mogen maximaal 10 jaar vóór het rapportagejaar zijn verzameld. Hierdoor kunnen de gebruikte data voor verschillende periodeoordelen overlappen en worden verschillen tussen planperioden minder goed zichtbaar. Daarom is er in deze rapportage voor gekozen om de laatste 3 meetjaren in specifieke tijdsintervallen te gebruiken voor een periodeoordeel.

```{r verschilkaart1, fig.cap = "Verschil tussen de ecologische kwaliteit van waterplanten sinds de start van de monitoring (gebaseerd op metingen 2006 t/m 2013) en de drie meest recente meetjaren (2020 t/m 2022).", echo = FALSE, message = FALSE, warning = FALSE, out.width='100%'}
# difference between most recent (wbp3) and reference (2006-2013)
wbp03 <- merge(tabsetwbp3[,c('EAGIDENT','id','GHPR_level', 'EKR3jr')], tabset, by = c('EAGIDENT','id','GHPR_level'))
wbp03$verschil <- wbp03$EKR3jr.x - wbp03$EKRref

# maak verschillenkaart
maatlat <- "2V1 Overige waterflora"
gebiedData <- wbp03[!is.na(wbp03$EAGIDENT),]
gebiedData <- gebiedData[gebiedData$GHPR_level %in% maatlat,]

'8' -> gebiedData$klasse[is.na(gebiedData$verschil)]
'7' -> gebiedData$klasse[gebiedData$verschil < -0.15]
'6' -> gebiedData$klasse[gebiedData$verschil >= -0.15 & gebiedData$verschil < -0.05]
'5' -> gebiedData$klasse[gebiedData$verschil >= -0.05 & gebiedData$verschil < 0.05]
'4' -> gebiedData$klasse[gebiedData$verschil >= 0.05 & gebiedData$verschil < 0.15]
'3' -> gebiedData$klasse[gebiedData$verschil >= 0.15]

gebiedData$param <- as.factor(gebiedData$klasse)
gebiedData$param = factor(gebiedData$param, levels = c("3", "4", "5", "6","7", "8"))
col1 <- c('3'="darkgreen", '4'="chartreuse",'5'= 'lightyellow', '6'="darksalmon",'7'= 'darkred','8' = "#808080")
labels1 <- c('3'="sterke vooruitgang",'4'="lichte vooruitgang",'5'="gelijk",'6'="lichte achteruitgang" ,'7'="sterke achteruitgang", '8'="geen gegevens")

pal <- colorFactor(palette = col1,  domain = gebiedData$param)
map <- sp::merge(gEAG,gebiedData[,c('param','EKR3jr.x','EKRref','oordeel_2022',
                                    'EAGIDENT','GEP_2022',
                                    'watertype','GHPR_level','EKRperc90','param')], by.x = 'GAFIDENT', by.y =
                   'EAGIDENT', all.x = TRUE, duplicateGeoms = F)

leaflet() %>%
  addPolygons(data = map, layerId = map$GAFIDENT, 
              popup= paste("EAG naam", map$GAFNAAM, "<br>",
                           "Referentiescore:", map$EKRref, "<br>",
                           "EKR score wbp3:", map$EKR3jr.x, "<br>",
                           "Oordeel toestand 2023:", map$oordeel_2022, "<br>",
                           "Doel:", map$GEP_2022, "<br>",
                           "Percentiel90:", map$EKRperc90, "<br>",
                           "Maatlat:", map$GHPR_level),
              stroke = T, color= 'grey', opacity=0.8, weight = 0.5, smoothFactor = 0.8,
              fill=T, fillColor = ~pal(param), fillOpacity = 0.6) %>%
  addLegend("bottomright", colors = col1, 
            labels= labels1,
            title = 'Verschil toestand 2023 en referentietoestand')%>%
  addProviderTiles("Esri.WorldGrayCanvas")#addTiles()


```


```{r verschilkaart2, fig.cap = "Verschil tussen de ecologische kwaliteit van de waterplanten aan het einde van de planperiode van SGBP2 (gebaseerd op metingen 2015 t/m 2020) en de drie meest recente meetjaren (2020 t/m 2022).", echo = FALSE, message = FALSE, warning = FALSE, out.width='100%', eval = FALSE, include=FALSE}

# difference between end wbp2 (2021 - data up 2 2020) and most recent
wbp23 <- merge(tabsetwbp3[,c('EAGIDENT','id','GHPR_level', 'EKR3jr')], tabsetwbp2, by = c('EAGIDENT','id','GHPR_level'))
wbp23$verschil <- wbp23$EKR3jr.x - wbp23$EKR3jr.y

# difference between end wbp1 (2015 - data up 2 2014) and reference (2006-2013)
tabsetwbp1$verschil <- tabsetwbp1$EKR3jr - tabsetwbp1$EKRref

# maak verschillenkaart
maatlat <- "2V1 Overige waterflora"
gebiedData <- wbp23[!is.na(wbp23$EAGIDENT),]
gebiedData <- gebiedData[gebiedData$GHPR_level %in% maatlat,]

'8' -> gebiedData$klasse[is.na(gebiedData$verschil)]
'7' -> gebiedData$klasse[gebiedData$verschil < -0.15]
'6' -> gebiedData$klasse[gebiedData$verschil >= -0.15 & gebiedData$verschil < -0.05]
'5' -> gebiedData$klasse[gebiedData$verschil >= -0.05 & gebiedData$verschil < 0.05]
'4' -> gebiedData$klasse[gebiedData$verschil >= 0.05 & gebiedData$verschil < 0.15]
'3' -> gebiedData$klasse[gebiedData$verschil >= 0.15]
gebiedData$param <- as.factor(gebiedData$klasse)
gebiedData$param = factor(gebiedData$param, levels = c("3", "4", "5", "6","7", "8"))
col1 <- c('3'="darkgreen", '4'="chartreuse",'5'= 'lightyellow', '6'="darksalmon",'7'= 'darkred','8' = "#808080")
labels1 <- c('3'="sterke vooruitgang",'4'="lichte vooruitgang",'5'="gelijk",'6'="lichte achteruitgang" ,'7'="sterke achteruitgang", '8'="geen gegevens")

pal <- colorFactor(palette = col1,  domain = gebiedData$param)
map <- sp::merge(gEAG,gebiedData[,c('param','EKR3jr.x','EKR3jr.y','EKRref','oordeel_2022',
                                    'EAGIDENT','GEP_2022',
                                    'watertype','GHPR_level','EKRperc90')], by.x = 'GAFIDENT', by.y =
                   'EAGIDENT', all.x = TRUE, duplicateGeoms = T)

leaflet() %>%
  addPolygons(data = map, layerId = map$GAFIDENT, 
              popup= paste("EAG naam", map$GAFNAAM, "<br>",
                           "Referentiescore:", map$EKRref, "<br>",
                           "EKR score wbp2:", map$EKR3jr.y, "<br>",
                           "EKR score meest recent:", map$EKR3jr.x, "<br>",
                           "Oordeel wbp2 :", map$oordeel_2022, "<br>",
                           "Doel:", map$GEP_2022, "<br>",
                           "Percentiel90 wbp2:", map$EKRperc90, "<br>",
                           "Maatlat:", map$GHPR_level ),
              stroke = T, color= 'grey', opacity=0.8, weight = 0.5, smoothFactor = 0.8,
              fill=T, fillColor = ~pal(param), fillOpacity = 0.6) %>%
  addLegend("bottomright", colors = col1, 
            labels= labels1,
            title = 'Verschil toestand 2021 en toestand 2023')%>%
  addProviderTiles("Esri.WorldGrayCanvas")#addTiles()




```


```{r verschilkaart3, fig.cap = "Verschil tussen de ecologische kwaliteit van waterplanten sinds de start van de monitoring (gebaseerd op metingen 2006 t/m 2013) en het einde van de planperiode van SGBP1 (gebaseerd op metingen 2006 t/m 2014).", echo = FALSE, message = FALSE, warning = FALSE, out.width='100%', eval = FALSE, include=FALSE}

# difference between end wbp1 (2015 - data up 2 2014) and reference (2006-2013)
tabsetwbp1$verschil <- tabsetwbp1$EKR3jr - tabsetwbp1$EKRref

# maak verschillenkaart
maatlat <- "2V1 Overige waterflora"
gebiedData <- tabsetwbp1[!is.na(tabsetwbp1$EAGIDENT),]
gebiedData <- gebiedData[gebiedData$GHPR_level %in% maatlat,]

'8' -> gebiedData$klasse[is.na(gebiedData$verschil)]
'7' -> gebiedData$klasse[gebiedData$verschil < -0.15]
'6' -> gebiedData$klasse[gebiedData$verschil >= -0.15 & gebiedData$verschil < -0.05]
'5' -> gebiedData$klasse[gebiedData$verschil >= -0.05 & gebiedData$verschil < 0.05]
'4' -> gebiedData$klasse[gebiedData$verschil >= 0.05 & gebiedData$verschil < 0.15]
'3' -> gebiedData$klasse[gebiedData$verschil >= 0.15]
gebiedData$param <- as.factor(gebiedData$klasse)
gebiedData$param = factor(gebiedData$param, levels = c("3", "4", "5", "6","7", "8"))
col1 <- c('3'="darkgreen", '4'="chartreuse",'5'= 'lightyellow', '6'="darksalmon",'7'= 'darkred','8' = "#808080")
labels1 <- c('3'="sterke vooruitgang",'4'="lichte vooruitgang",'5'="gelijk",'6'="lichte achteruitgang" ,'7'="sterke achteruitgang", '8'="geen gegevens")

pal <- colorFactor(palette = col1,  domain = gebiedData$param)
map <- sp::merge(gEAG,gebiedData[,c('param','EKR3jr','EKRref','oordeel_2022',
                                    'EAGIDENT','GEP_2022',
                                    'watertype','GHPR_level','EKRperc90')], by.x = 'GAFIDENT', by.y =
                   'EAGIDENT', all.x = TRUE, duplicateGeoms = T)

leaflet() %>%
  addPolygons(data = map, layerId = map$GAFIDENT, 
              popup= paste("EAG naam", map$GAFNAAM, "<br>",
                           "Referentiescore:", map$EKRref, "<br>",
                           "EKR score wbp 1:", map$EKR3jr, "<br>",
                           "Oordeel wbp 1 :", map$oordeel_2022, "<br>",
                           "Doel:", map$GEP_2022, "<br>",
                           "Percentiel90 wbp 1:", map$EKRperc90, "<br>",
                           "Maatlat:", map$GHPR_level ),
              stroke = T, color= 'grey', opacity=0.8, weight = 0.5, smoothFactor = 0.8,
              fill=T, fillColor = ~pal(param), fillOpacity = 0.6) %>%
  addLegend("bottomright", colors = col1, 
            labels= labels1,
            title = 'Verschil toestand 2015 en referentietoestand')%>%
  addProviderTiles("Esri.WorldGrayCanvas")#addTiles()




```

Per maatlat en ecologisch analysegebied is daarnaast berekend hoe de ecologische kwaliteit zich ontwikkeld door een lineaire trend van EKR te berekenen. Uit deze ontwikkeling van ecologische waterkwaliteit blijkt dat op veel plaatsen de waterkwaliteit achteruit gaat. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$estimate < 0 &!is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan, ondanks onze pogingen om het omgaan met water (gebiedsontwikkelingen, agrarisch gebruik, afvalwaterbeheer (opsporen foutaansluitingen)) te beïnvloeden en onze inzet om sloten, zuiveringsinstallaties en waterpeilen te beheren.

```{r trenddkaart, fig.cap = "Ontwikkeling in ecologische kwaliteit", echo = FALSE, message = FALSE, warning= FALSE, out.width='100%'}
#krw<- 
combineWidgets(
  nrow = 2,
  plottrendEAG(ekrtrendeag, gEAG, maatlat = "Overige waterflora-kwaliteit"),
  plottrendEAG(ekrtrendeag, gEAG, maatlat = "Macrofauna-kwaliteit"),
  plottrendEAG(ekrtrendeag, gEAG, maatlat = "Fytoplankton-kwaliteit"),
  plottrendKRW(ekrtrend[ekrtrend$facet_wrap_code == 'Vis',], gKRW)
)

# combineWidgets(
#     nrow = 1,
#     plottrendEAG(ekrtrendeag20p[ekrtrendeag20p$facet_wrap_code == 'Waterflora',], gEAG),
#     plottrendEAG(ekrtrendeag[ekrtrendeag$facet_wrap_code == 'Waterflora',], gEAG),
#     plottrendEAG(ekrtrendeag80p[ekrtrendeag80p$facet_wrap_code == 'Waterflora',], gEAG)
#   
# )
# saveWidget(krw, "trendallemaatlatten.html", selfcontained = FALSE)
```

Er zijn ook ecologisch analysegebied waar de ecologische kwaliteit verbetert door maatregelen die de afgelopen jaren zijn uitgevoerd. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$estimate > 0 &!is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat de vegetatie vooruit is gegaan. De succesfactoren voor het herstel van deze waterlichamen worden per factor toegelicht in het rapport Ecologische sleutelfactoren in beeld.

In `r round((length(ekrtrendeag$estimate[ekrtrendeag$estimate == 0|is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate))*100, 0)`% van de gebieden en maatlatten is de ontwikkeling in ecologische waterkwaliteit min of meer stabiel of zijn er onvoldoende gegevens beschikbaar om de ontwikkeling goed in beeld te brengen. 

## Toestand per biologisch kwaliteitselement

Als graadmeter voor de (ecologische) toestand in het gehele beheergebied is de hoeveelheid en soortensamenstelling van de aanwezige vegetatie (waterplanten) gebruikt. Dit vormt namelijk een goede maatstaf voor de ecologische toestand van een oppervlaktewater: waterplanten zijn een essentieel onderdeel van, en randvoorwaarde voor watergebonden leven als kleine waterdiertjes en vissen. De aanwezigheid van waterplanten is getoetst volgens de landelijke maatlatten voor sloten, kanalen en meren. In gebieden die zijn aangewezen als KRW waterlichaam wordt sinds 2006 ook de toestand van de andere drie biologische kwaliteitselementen (fytoplankton, macrofauna, en vissen) ook gevolgd.

### Overige waterflora

Het beheergebied van AGV is zeer divers en daarom opgedeeld in kleinere [Ecologische analysegebieden](EAG), elk met een eigen bodemtype en waterhuishouding. In elk gebied is de hoeveelheid en soortensamenstelling van waterplanten op meerdere plaatsen gemeten en getoetst. De vegetatie wordt gemiddeld eens in de 3 jaar gemeten in ieder EAG. In onderstaande afbeeldingen worden de berekende oordelen, doelen en EKR scores per Ecologisch analysegebied op vegetatiemaatlat weergegeven. Als je op een deelgebied klikt, dan verschijnt er een pop-up waar je kan zien wat de EKR score is. 

In afbeelding \@ref(fig:kaartenekroordeeldoelmcft) staan de berkende EKR scores, doelen en de oordelen die daaruit volgen weergegeven zodat zichtbaar wordt hoe het oordeel is opgebouwd. De actuele toestand van vegetatie is gebaseerd op metingen in meerdere jaren. De gemeten vegetatie laat van nature fluctuaties zien in de tijd en een gemiddelde van verschillende jaren geeft een betrouwbaarder beeld van de ecologische toestand. In de systematiek van de KRW wordt een oordeel gegeven door dit ‘slepend gemiddelde’ van EKR scores per gebied te vergelijken met een doel.

```{r kaartenekroordeeldoelmcft, fig.cap = 'Overzicht van oordelen, EKR scores en doelen op de maatlat overige waterflora.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}
# ekr_scores2 <- ekr_scores2[ekr_scores2$KRW_SGBP3 == "",] #alleen ov water
# krw <-
#   KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Ov. waterflora" ,],
#               maatlat = "2V1 Overige waterflora", param = "ekrref")

combineWidgets(
  ncol = 4,
  KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Ov. waterflora" ,], 
            maatlat = "2V1 Overige waterflora", param = "ekr3jr"),
  KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Ov. waterflora" ,], 
            maatlat = "2V1 Overige waterflora", param = "doel"),
  KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Ov. waterflora" ,], 
            maatlat = "2V1 Overige waterflora", param = "oordeel"),
  KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Ov. waterflora" ,], 
            maatlat = "2V1 Overige waterflora", param = "doelgat")
)


# saveWidget(krw, "referentie.html", selfcontained = FALSE)
#webshot("waterflora.html", file = "waterflora.png")

```

In veel waterlichamen worden doelen nog niet gehaald. Niet in alle gebieden is het onze ambitie om hoger te scoren dan een EKR van 0.6 (groen). Er is voor ieder water gekeken naar een haal- en betaalbaar handelingsperspectief. Op basis daarvan worden uiteindelijke doelen of ambities geformuleerd. In onderstaande kaart staat weergegeven hoe groot de opgave is om de doelen te bereiken.

Voor overig water worden op dit moment haalbare maatregelenpakketten bedacht om het handelingsperspectief en doelen te bepalen. Een eerste aanzet voor doelen overig water is nu gemaakt op basis van het 90 percentiel van gemeten EKR scores in een gebied. Deze 10% beste meetlocaties geven namelijk een eerste beeld van een realistisch ecologische toestand die voor kan komen in een EAG.

```{r doelgatmap, fig.cap = 'Overzicht van het doelgat (de afstand van de huidige toestand tot het doel) voor de maatlat Overige waterflora.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}

KRWmapEAG(gEAG, ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Ov. waterflora" ,], 
          maatlat = "2V1 Overige waterflora", param = 'doelgat')

#doelmapEAG(tabset[tabset$wbmethode == "Maatlatten2018 Ov. waterflora" & !tabset$KRW_SGBP3 == "",], maatlat = "2V1 Overige waterflora") #alleenovwater
```

```{r soortenmvsp, fig.cap = 'Soortensamenstelling versus fosforbelasting in sloten', eval = FALSE, echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
#merge macft en pbel
srtbelas <- merge(ekr_scores2[ekr_scores2$GHPR == 'Soortensamenstelling macrofyten Waterplanten',], pvskp, by.x = 'EAGIDENT', by.y = 'EAG')
srtbelas <- srtbelas[!is.na(srtbelas$wp_min_sum) & ! is.na(srtbelas$EKR3jr),]
srtbelas$pbands <- cut(srtbelas$wp_min_sum, breaks = 20)
srtbelas$w_debiet <- cut(srtbelas$w_debiet, breaks = 15)

p <- ggplot(srtbelas, aes(x= wp_min_sum, y= EKR3jr, label = paste0(waterlichaam), col = watertype.x))+
  geom_jitter() +
  geom_quantile(quantiles = 0.9, na.rm = T, method = "rqss")+
  #facet_grid(~jaar, scales = 'free')+
  theme_minimal()+
  theme(
    strip.background = element_blank(),
    axis.text.x = element_text(angle = 30, hjust =1),
    axis.text.y = element_text(size= 7),
    panel.background = element_blank(),
    plot.background = element_blank(),
    axis.title = element_text(size=10),
    axis.ticks =  element_line(colour = "black"),
    axis.line = element_line(colour='black'))+
  theme(legend.title = element_text(size = 7, face = 'bold'),
        legend.text  = element_text(size = 7),
        legend.key.size = unit(0.9, "lines"),
        legend.position = "right")+
  ggtitle("EKR waterplanten tov fosforbelasting") +
  labs(x= 'P-bel', y= 'ekr soorten waterplanten')
# krw <-
ggplotly(p=p)
# saveWidget(krw, "visversuskP.html", selfcontained = FALSE)
```

#### Ontwikkeling Overige waterflora

In afbeelding \@ref(fig:kaartvegjaren) is te zien hoe de vegetatie scoort (EKR score op de maatlat 'Overige waterflora') in verschillende meetjaren. Er worden 3 meetjaren op één kaart weergegeven zodat er een zo goed mogelijk gebiedsbreed beeld wordt gegeven. In ieder vlak (EAG) wordt namelijk maar één keer per 3 jaar vegetatie gemeten. Om te kunnen zien waar de gemiddelde EKR score uit is opgebouwd, kunnen EKR scores ook per meetpunt worden weergegeven. In de afbeelding hieronder staat zowel de score per EAG als de ruimtelijke spreiding van de ecologische kwaliteit op basis van de berekende EKR score per meetlocatie. 

```{r kaartvegjaren, fig.cap = 'Overzicht van EKR scores per EAG per jaar op de maatlat Overige waterflora.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}
#krw <-
combineWidgets(
  ncol = 4, colsize = c(1,1),
  ekrmap_mpeag(EKRset[EKRset$jaar >= '2006' & EKRset$jaar < '2010',], gEAG,
               maatlat = "2V1 Overige waterflora",col=col, labels=labels),
  ekrmap_mpeag(EKRset[EKRset$jaar >= '2010' & EKRset$jaar < '2014',], gEAG,
               maatlat = "2V1 Overige waterflora",col=col, labels=labels),
  ekrmap_mpeag(EKRset[EKRset$jaar >= '2014' & EKRset$jaar < '2018',], gEAG,
               maatlat = "2V1 Overige waterflora",col=col, labels=labels),
  ekrmap_mpeag(EKRset[EKRset$jaar >= '2018' & EKRset$jaar < '2022',], gEAG,
               maatlat = "2V1 Overige waterflora",col=col, labels=labels)
)

# saveWidget(krw, "waterflorapermpjaar.html", selfcontained = FALSE)
#webshot("waterflora.html", file = "waterflora.png")
```

De ontwikkeling van de ecologische kwaliteit is met een lineaire trend. Uit deze trends in de toestand van waterkwaliteit blijkt dat op veel plaatsen de vegetatie (overige waterflora) achteruit gaat. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '2V1 Overige waterflora' & ekrtrendeag$estimate < 0 & !is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '2V1 Overige waterflora']))*100, 0)`% van de gebieden is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan op de maatlat overige waterflora.

Er zijn ook ecologisch analysegebied waar de ecologische kwaliteit verbetert. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '2V1 Overige waterflora' & ekrtrendeag$estimate > 0 & !is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '2V1 Overige waterflora']))*100, 0)`% van de gebieden is met een hoge betrouwbaarheid vast te stellen dat de vegetatie vooruit is gegaan op de maatlat overige waterflora. De succesfactoren voor het herstel van deze waterlichamen worden per factor toegelicht in het rapport Ecologische sleutelfactoren in beeld.

In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '2V1 Overige waterflora' & (ekrtrendeag$estimate == 0| is.na(ekrtrendeag$estimate))])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '2V1 Overige waterflora']))*100, 0)`% van de gebieden is de ontwikkeling op de maatlat overige waterflora min of meer stabiel of zijn er onvoldoende gegevens beschikbaar om de ontwikkeling goed in beeld te brengen. 

```{r trendveg1, fig.cap = 'Overzicht van de trend in EKR scores op de maatlat overige waterflora per ecologisch analysegebied tussen 2006 en 2021', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}

# krw<-
combineWidgets(
  ncol = 2,
  plottrendEAG(trendekreag, gEAG, maatlat = "Soortensamenstelling macrofyten"),
  plottrendEAG(trendekreag, gEAG,maatlat = "Soortensamenstelling macrofyten Oeverplanten"),
  plottrendEAG(trendekreag, gEAG, maatlat = "Soortensamenstelling macrofyten Waterplanten")
)

# combineWidgets(
#     ncol = 3,
#     plottrendEAG(trendekreag20p[trendekreag20p$GHPR_level == '2V21 Soortensamenstelling macrofyten',], gEAG),
#     plottrendEAG(trendekreag[trendekreag$GHPR_level == '2V21 Soortensamenstelling macrofyten',], gEAG),
#     plottrendEAG(trendekreag80p[trendekreag80p$GHPR_level == '2V21 Soortensamenstelling macrofyten',], gEAG)
#     )

#krw <-
combineWidgets(
  ncol = 2,
  plottrendEAG(trendekreag, gEAG, maatlat = c("Abundantie groeivormen macrofyten")),
  plottrendEAG(trendekreag, gEAG, maatlat = c('Bedekking som submerse planten en draadalgen', 'Waterdiepte')),
  plottrendEAG(trendekreag, gEAG, maatlat = c('Bedekking Emerse planten')),
  plottrendEAG(trendekreag, gEAG, maatlat = c("Bedekking Kroos")),
  plottrendEAG(trendekreag, gEAG, maatlat = c("Bedekking Flab (Floating Algae Beds)"))
  )
# saveWidget(krw, "trenddeelmtltwaterflorasoorten_20062019.html", selfcontained = FALSE)
# webshot("trendbiodivwaterflora.html", file = "trendbiodivwaterflora.png")
```

In `r round((length(trendekreag$estimate[trendekreag$GHPR_level == '2V21 Soortensamenstelling macrofyten' & (trendekreag$estimate < 0| is.na(trendekreag$estimate))])/length(trendekreag$estimate[trendekreag$GHPR_level == '2V21 Soortensamenstelling macrofyten']))*100, 0)`% van de gebieden is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan op de indicator soortensamenstelling macrofyten.

In `r round((length(trendekreag$estimate[trendekreag$GHPR_level == '2V3 Bedekking som submerse planten en draadalgen' & (trendekreag$estimate < 0| is.na(trendekreag$estimate))])/length(trendekreag$estimate[trendekreag$GHPR_level == '2V3 Bedekking som submerse planten en draadalgen']))*100, 0)`% van de gebieden is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan op de indicator bedekking submerse planten.

In `r round((length(trendekreag$estimate[trendekreag$GHPR == 'Soortensamenstelling macrofyten Waterplanten' & (trendekreag$estimate < 0| is.na(trendekreag$estimate))])/length(trendekreag$estimate[trendekreag$GHPR == 'Soortensamenstelling macrofyten Waterplanten']))*100, 0)`% van de gebieden is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan op de indicator soortensamenstelling waterplanten in sloten.

In `r round((length(trendekreag$estimate[trendekreag$GHPR == 'Soortensamenstelling macrofyten Oeverplanten' & (trendekreag$estimate < 0| is.na(trendekreag$estimate))])/length(trendekreag$estimate[trendekreag$GHPR == 'Soortensamenstelling macrofyten Oeverplanten']))*100, 0)`% van de gebieden is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan op de indicator soortensamenstelling oeverplanten in sloten.

### Fytoplankton

In gebieden die zijn aangewezen als KRW waterlichaam wordt sinds 2006 de toestand van fytoplankton, macrofauna, en vissen gevolgd. Deze zogenaamde kwaliteitselementen worden eens in de 3 of 6 jaar gemeten. In onderstaande afbeeldingen worden de berekende EKR scores per [KRW waterlichamen] en kwaliteitselement weergegeven.

```{r kaartKRWfyto, fig.cap = 'Overzicht van oordelen, EKR scores en doelen op de maatlat op de maatlat Fytoplankton.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
#krw <- 
combineWidgets(
  ncol = 3,
  KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Fytoplankton" ,], 
            maatlat = "1F1 Fytoplankton-kwaliteit", param = "oordeel"),
  KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Fytoplankton" ,], 
            maatlat = "1F1 Fytoplankton-kwaliteit", param = "ekr3jr"),
  KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Fytoplankton" ,], 
            maatlat = "1F1 Fytoplankton-kwaliteit", param = "doel")
)

# saveWidget(krw, "fytoplankton.html", selfcontained = FALSE)
#webshot("fytoplankton.html", file = "fytoplankton.png")
```

In veel waterlichamen worden doelen nog niet gehaald. Niet in alle gebieden is het onze ambitie om hoger te scoren dan een EKR van 0.6 (groen). Er is voor ieder water gekeken naar een haal- en betaalbaar handelingsperspectief. Op basis daarvan worden uiteindelijke doelen of ambities geformuleerd. In onderstaande kaart staat weergegeven hoe groot de opgave is om de doelen te bereiken.

```{r doelgatmapfyto, fig.cap = 'Overzicht van het doelgat (de afstand van de huidige toestand tot het doel) voor de maatlat Fytoplankton.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}

KRWmapEAG(gEAG, ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Fytoplankton" ,], 
          maatlat = "1F1 Fytoplankton-kwaliteit", param = 'doelgat')
```

Fytoplankton reageert vaak sneller op ontwikkelingen dan vegetatie. Vooral in grotere wateren is dit ook een goede indicator voor schoon water en zwemwaterkwaliteit. Fytoplankton laat globaal eenzelfde beeld zien als vegetatie, al is er op deze maatlat minder sprake van achteruitgang. Naast de scores op de hoofdmaatlat 'Fytoplankton-kwaliteit' kan ook worden gekeken naar scores op de indicator 'abundantie fytoplankton', die is berekend op basis van het zomerhalfjaar gemiddelde Chlorofyl-A gehalte.

```{r kaartchlorofyl, fig.cap = 'Overzicht van gemiddeld chlorofyl-A gehalte in 2006 t/m 2014 links en 2014 t/m 2022 rechts.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
wq1 <- wq[grepl('VAST*', wq$`locatie meetnethistorie`),]
#wq2 <- wq1[wq1$] # voor een boezemkaartje
#chlfa<-
combineWidgets(
  ncol = 2, colsize = c(1, 1),
  chlorofylA(wq1[wq1$jaar < '2015'& wq1$jaar > '2005',], gEAG),
  chlorofylA(wq1[wq1$jaar > '2014'& wq1$jaar < '2022',], gEAG)
)
#saveWidget(chlfa, "chlfa.html", selfcontained = FALSE)
#webshot("chlfa.html", file = "chlfa.png")
```

#### Ontwikkeling Fytoplankton

In afbeelding \@ref(fig:kaartfytojaren) is te zien hoe fytoplankton scoort in verschillende meetjaren. Er worden 3 meetjaren op één kaart weergegeven zodat er een zo goed mogelijk gebiedsbreed beeld wordt gegeven. In ieder vlak (EAG) wordt namelijk maar één keer per 3 of 6 jaar de samenstelling van fytoplankton gemeten. Om te kunnen zien waar de gemiddelde EKR score uit is opgebouwd, kunnen EKR scores ook per meetpunt worden weergegeven. In de afbeelding hieronder staat zowel de score per EAG als de ruimtelijke spreiding van de ecologische kwaliteit op basis van de berekende EKR score per meetlocatie. 

```{r kaartfytojaren, fig.cap = 'Overzicht van EKR scores per EAG per jaar op de maatlat Fytoplankton.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}

#krw <-
combineWidgets(
  ncol = 4, 
  ekrmap_mpeag(EKRset[EKRset$jaar >= '2006' & EKRset$jaar < '2010',], gEAG,
               maatlat = "1F1 Fytoplankton-kwaliteit",col=col, labels=labels),
  ekrmap_mpeag(EKRset[EKRset$jaar >= '2010' & EKRset$jaar < '2014',], gEAG,
               maatlat = "1F1 Fytoplankton-kwaliteit",col=col, labels=labels),
  ekrmap_mpeag(EKRset[EKRset$jaar >= '2014' & EKRset$jaar < '2018',], gEAG,
               maatlat = "1F1 Fytoplankton-kwaliteit",col=col, labels=labels),
  ekrmap_mpeag(EKRset[EKRset$jaar >= '2018' & EKRset$jaar < '2022',], gEAG,
               maatlat = "1F1 Fytoplankton-kwaliteit",col=col, labels=labels)
)

# saveWidget(krw, "fytopermpjaar.html", selfcontained = FALSE)
#webshot("waterflora.html", file = "waterflora.png")

```

De ontwikkeling van de ecologische kwaliteit is met een lineaire trend. Uit deze trends in de toestand van waterkwaliteit blijkt dat op veel plaatsen de vegetatie (overige waterflora) achteruit gaat. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '1F1 Fytoplankton-kwaliteit' & ekrtrendeag$estimate < 0 & !is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '1F1 Fytoplankton-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan.

Er zijn ook ecologisch analysegebied waar de ecologische kwaliteit verbetert. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '1F1 Fytoplankton-kwaliteit' & ekrtrendeag$estimate > 0 & !is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '1F1 Fytoplankton-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat de vegetatie vooruit is gegaan. De succesfactoren voor het herstel van deze waterlichamen worden per factor toegelicht in het rapport Ecologische sleutelfactoren in beeld.

In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '1F1 Fytoplankton-kwaliteit' & (ekrtrendeag$estimate == 0| is.na(ekrtrendeag$estimate))])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '1F1 Fytoplankton-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is de ontwikkeling in ecologische waterkwaliteit min of meer stabiel of zijn er onvoldoende gegevens beschikbaar om de ontwikkeling goed in beeld te brengen. 

```{r trendfyt1, fig.cap = 'Overzicht van de trend in EKR scores op de maatlat fytoplankton per ecologisch analysegebied tussen 2006 en 2019', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}

#krw<-
combineWidgets(
  ncol = 3,
  plottrendEAG(trendekreag, gEAG, maatlat = "Fytoplankton-kwaliteit"),
  plottrendEAG(trendekreag, gEAG, maatlat = "Abundantie fytoplankton"   ),
  plottrendEAG(trendekreag, gEAG, maatlat = "Soortensamenstelling fytoplankton")
)
# saveWidget(krw, "trenddeelmtltfyto.html", selfcontained = FALSE)
# webshot("trendbiodivwaterflora.html", file = "trendbiodivwaterflora.png")
```

### Macrofauna

Macrofauna zijn kleine, maar met het blote oog zichtbare, ongewervelde dieren (insecten, slakken, etc) die in het oppervlaktewater leven. Van elk meetpunt van is de aanwezige macrofauna vergeleken met een voor ieder watertype maximaal haalbare kwaliteit. Aquatische macrofauna heeft vegetatie nodig als schuilplaats, voedsel of voor hun voortplanting. Daarom is een gezonde macrofaunagemeenschap afhankelijk van de hoeveelheid en kwaliteit van emerse en submerse vegetatie.

In afbeelding \@ref(fig:kaartenekroordeeldoelmafa) staan de berkende EKR scores, doelen en de oordelen die daaruit volgen weergegeven zodat zichtbaar wordt hoe het oordeel is opgebouwd. De actuele toestand van macrofauna is gebaseerd op metingen in meerdere jaren. De gemeten vegetatie laat van nature fluctuaties zien in de tijd en een gemiddelde van verschillende jaren geeft een betrouwbaarder beeld van de ecologische toestand. In de systematiek van de KRW wordt een oordeel gegeven door dit ‘slepend gemiddelde’ van EKR scores per gebied te vergelijken met een doel.

```{r kaartenekroordeeldoelmafa, fig.cap = 'Overzicht van oordelen, EKR scores en doelen op de maatlat macrofauna.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}
#krw<- 
combineWidgets(
  ncol = 3,
  KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Macrofauna" ,], 
            maatlat = "3M1 Macrofauna-kwaliteit", param = "oordeel"),
  KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Macrofauna" ,], 
            maatlat = "3M1 Macrofauna-kwaliteit", param = "ekr3jr"),
  KRWmapEAG(gEAG,ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Macrofauna" ,], 
            maatlat = "3M1 Macrofauna-kwaliteit", param = "doel")
)

# saveWidget(krw, "macrofauna.html", selfcontained = FALSE)
#webshot("waterflora.html", file = "waterflora.png")

```

In veel waterlichamen worden doelen nog niet gehaald. Niet in alle gebieden is het onze ambitie om hoger te scoren dan een EKR van 0.6 (groen). Er is voor ieder water gekeken naar een haal- en betaalbaar handelingsperspectief. Op basis daarvan worden uiteindelijke doelen of ambities geformuleerd. In onderstaande kaart staat weergegeven hoe groot de opgave is om de doelen te bereiken.

```{r doelgatmapmafa, fig.cap = 'Overzicht van het doelgat (de afstand van de huidige toestand tot het doel) voor de maatlat Macrofauna.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}

KRWmapEAG(gEAG, ekr_scores2[ekr_scores2$wbmethode == "Maatlatten2018 Macrofauna" ,], 
          maatlat = "3M1 Macrofauna-kwaliteit", param = 'doelgat')
```

De natuurkwaliteit van macrofauna is laag voor alle typen oppervlaktewater. Slechts op enkele plaatsen wordt een goede kwaliteit aangetroffen. In het achterland van Loosdrecht, de Tiehovense plassen, de Hollands Ankeveense plassen, de Westbroekse zodden, Molenpolder Natuur en het Hol valt op dat de score op de macrofauna maatlat voldoet, terwijl scores op de maatlat 'Overige waterflora' onvoldoende zijn. Macrofauna wordt minder frequent bemonsterd en daarom zijn deze resultaten meestal op oudere meetdata gebaseerd. Ook in eerdere meetjaren valt op dat macrofauna in bovengenoemde gebieden voldoet, terwijl de scores op de maatlat 'Overige waterflora' (vegetatie) niet voldoen. In het achterland van Loosdrecht gaat zowel de kwaliteit van macrofauna als waterflora achteruit.

```{r figmafa, fig.cap = 'Aantal individuen van gevoelige macrofauna uit de EPT groep (haften, steenvliegen, kokerjuffers) per monster', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
if(nrow(hybi[hybi$analysecode == 'MEA',])>0){
  plotmafa(hybi[!is.na(hybi$TWN.taxongroup),],TWNev)}
```

#### Ontwikkeling Macrofauna

In afbeelding \@ref(fig:kaartmafajaren) is te zien hoe macrofauna scoort in verschillende meetjaren. Er worden 3 meetjaren op één kaart weergegeven zodat er een zo goed mogelijk gebiedsbreed beeld wordt gegeven. In ieder vlak (EAG) wordt namelijk maar één keer per 3 jaar vegetatie gemeten. Om te kunnen zien waar de gemiddelde EKR score uit is opgebouwd, kunnen EKR scores ook per meetpunt worden weergegeven. In de afbeelding hieronder staat zowel de score per EAG als de ruimtelijke spreiding van de ecologische kwaliteit op basis van de berekende EKR score per meetlocatie. 

```{r kaartmafajaren, fig.cap = 'Overzicht van EKR scores per EAG per jaar op de maatlat Macrofauna.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}
#krw <-
combineWidgets(
  ncol = 4, 
  ekrmap_mpeag(EKRset[EKRset$jaar >= '2006' & EKRset$jaar < '2010',], gEAG,
               maatlat = "3M1 Macrofauna-kwaliteit",col=col, labels=labels),
  ekrmap_mpeag(EKRset[EKRset$jaar >= '2010' & EKRset$jaar < '2014',], gEAG,
               maatlat = "3M1 Macrofauna-kwaliteit",col=col, labels=labels),
  ekrmap_mpeag(EKRset[EKRset$jaar >= '2014' & EKRset$jaar < '2018',], gEAG,
               maatlat = "3M1 Macrofauna-kwaliteit",col=col, labels=labels),
  ekrmap_mpeag(EKRset[EKRset$jaar >= '2018' & EKRset$jaar < '2022',], gEAG,
               maatlat = "3M1 Macrofauna-kwaliteit",col=col, labels=labels)
)

#saveWidget(krw, "macrofaunapermpjaar.html", selfcontained = FALSE)
#webshot("waterflora.html", file = "waterflora.png")
```

De ontwikkeling van de ecologische kwaliteit is met een lineaire trend. Uit deze trends in de toestand van waterkwaliteit blijkt dat op veel plaatsen de vegetatie (overige waterflora) achteruit gaat. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '3M1 Macrofauna-kwaliteit' & ekrtrendeag$estimate < 0 & !is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '3M1 Macrofauna-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan.

Er zijn ook ecologisch analysegebied waar de ecologische kwaliteit verbetert. In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '3M1 Macrofauna-kwaliteit' & ekrtrendeag$estimate > 0 & !is.na(ekrtrendeag$estimate)])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '3M1 Macrofauna-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat de vegetatie vooruit is gegaan. De succesfactoren voor het herstel van deze waterlichamen worden per factor toegelicht in het rapport Ecologische sleutelfactoren in beeld.

In `r round((length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '3M1 Macrofauna-kwaliteit' & (ekrtrendeag$estimate == 0| is.na(ekrtrendeag$estimate))])/length(ekrtrendeag$estimate[ekrtrendeag$GHPR_level == '3M1 Macrofauna-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is de ontwikkeling in ecologische waterkwaliteit min of meer stabiel of zijn er onvoldoende gegevens beschikbaar om de ontwikkeling goed in beeld te brengen. 

```{r trendmafa1, fig.cap = 'Overzicht van de trend in EKR scores op de maatlat macrofauna per ecologisch analysegebied tussen 2006 en 2022', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
plottrendEAG(trendekreag, gEAG, maatlat = "Macrofauna-kwaliteit")
# saveWidget(krw, "trendbiodivwaterflora.html", selfcontained = FALSE)
# webshot("trendbiodivwaterflora.html", file = "trendbiodivwaterflora.png")
```

### Vis

In afbeelding \@ref(fig:kaartenekroordeeldoelvis) staan de berkende EKR scores, doelen en de oordelen die daaruit volgen weergegeven zodat zichtbaar wordt hoe het oordeel is opgebouwd. De actuele toestand van vis is gebaseerd op metingen in meerdere jaren. Visbemonsteringen laat van nature fluctuaties zien in de tijd en een gemiddelde van verschillende jaren geeft een betrouwbaarder beeld van de ecologische toestand. In de systematiek van de KRW wordt een oordeel gegeven door dit ‘slepend gemiddelde’ van EKR scores per gebied te vergelijken met een doel.

```{r kaartenekroordeeldoelvis, fig.cap = 'Overzicht van oordelen, EKR scores en doelen op de maatlat macrofauna.', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show ='hold'}
# vis is niet beschikbaar per eag --> daarom projectie KRW wl op alle eags van dat waterlichaam
ekr_scores_vis <- merge(tabset[tabset$wbmethode == "Maatlatten2018 Vis" ,], eag_wl[!eag_wl$KRW_SGBP3 == "", c('GAFIDENT','KRW_SGBP3')], by = 'KRW_SGBP3', all.y = T, allow.cartesian = T)
ekr_scores_vis$EAGIDENT <- ekr_scores_vis$GAFIDENT

krw <- combineWidgets(
  ncol = 3,
  KRWmapEAG(gEAG,ekr_scores_vis, 
            maatlat = "4VI1 Vis-kwaliteit" , param = "oordeel"),
  KRWmapEAG(gEAG,ekr_scores_vis, 
            maatlat = "4VI1 Vis-kwaliteit" , param = "ekr3jr"),
  KRWmapEAG(gEAG,ekr_scores_vis, 
            maatlat = "4VI1 Vis-kwaliteit" , param = "doel")
)
krw
# saveWidget(krw, "vistoestand.html", selfcontained = FALSE)

```

```{r vispivot, fig.cap = 'Visbiomassa per soort', eval = FALSE, echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}

selKol <- c("Numeriekewaarde","Biotaxon.naam.nl","HoortBijGeoobject.identificatie","Begindatum","Resultaatdatum","HoortBijGeoObjectCode","Eenheid.code")
#only weighted scores (not present in current output)
vislijst <- EKRlijst[!grepl('^NL11*', EKRlijst$HoortBijGeoobject.identificatie),]
vislijst <- vislijst[!is.na(vislijst$Biotaxon.naam.nl) & !vislijst$Biotaxon.naam.nl == "",]

sel <- sel & !is.na(EKRlijst$Biotaxon.naam.nl) & !EKRlijst$Biotaxon.naam.nl == "" &!(EKRlijst$Biotaxon.naam.nl %in% "Vissen")  #als geen nederlandse naam dan gaat aggregate fout. En ook niet relevant.
sel <- sel & EKRlijst$Eenheid.code %in% "kg/ha"

EKRlijst1 <- EKRlijst[sel,]
EKRlijst1 <- EKRlijst1[,ltstmj := jaar==max(jaar,na.rm=T), by = c('HoortBijGeoobject.identificatie','EAGIDENT')]
EKRlijst1 <- EKRlijst1[ltstmj == TRUE,]

xagg <- aggregate(Numeriekewaarde ~ Biotaxon.naam.nl+jaar+HoortBijGeoobject.identificatie,EKRlijst1,FUN=sum)
xagg$jaar <- as.character(xagg$jaar)
colgroup <-c('Biotaxon.naam.nl','jaar','HoortBijGeoobject.identificatie','Numeriekewaarde')

# rename columns and order data.table
setnames(xagg,colgroup,c('vissoort','jaar','waterlichaam','biomassa'))
xagg <- as.data.frame(xagg)

# calculate mean per groep
krw <- rpivotTable(
  xagg,
  rows=c("waterlichaam","jaar"),
  cols= "vissoort",
  aggregatorName = "Sum",
  # sorter = '',
  # inclusions = list(HoortBijGeoobject.identificatie = list("NL11_Botshol")),
  exclusions= list(jaar = list('2006','2007','2008','2009','2010','2011','2012')),
  vals = "biomassa",
  rendererName = "Horizontal Stacked Bar Chart",
  width="100%"
)
krw
# saveWidget(krw, "vispivot.html", selfcontained = FALSE)
```

```{r visbiomvsp, fig.cap = 'Visbiomassa versus fosforbelasting', eval = FALSE, echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}

selKol <- c("Numeriekewaarde","Biotaxon.naam.nl","HoortBijGeoobject.identificatie","Begindatum","Resultaatdatum","HoortBijGeoObjectCode","Eenheid.code","GeoObject.code")
sel <- !grepl('^NL11*', EKRlijst$HoortBijGeoobject.identificatie)
sel <- sel & !is.na(EKRlijst$Biotaxon.naam.nl) & !EKRlijst$Biotaxon.naam.nl == "" &!(EKRlijst$Biotaxon.naam.nl %in% "Vissen")  #als geen nederlandse naam dan gaat aggregate fout. En ook niet relevant.
sel <- sel & EKRlijst$Eenheid.code %in% "kg/ha"
EKRlijst1 <- EKRlijst[sel,]

xagg <- aggregate(Numeriekewaarde ~ Biotaxon.naam.nl+jaar+HoortBijGeoobject.identificatie+GeoObject.code,EKRlijst1,FUN=sum)
xagg$jaar <- as.character(xagg$jaar)
xagg <- aggregate(Numeriekewaarde ~ jaar+HoortBijGeoobject.identificatie+GeoObject.code,xagg,FUN=sum)


colgroup <-c('jaar','HoortBijGeoobject.identificatie','Numeriekewaarde','GeoObject.code')
# rename columns and order data.table
setnames(xagg,colgroup,c('jaar','waterlichaam','biomassa','ident'))

#merge vis en pbel
visbelas <- merge(xagg, pvskp, by.x = 'ident', by.y = 'KRW')

p<- ggplot(visbelas, aes(x= wp_min_sum, y= biomassa, col = watertype, label = paste0(waterlichaam, jaar.x)))+
  geom_jitter() +
  #facet_grid(~jaar, scales = 'free')+
  theme_minimal()+
  theme(
    strip.background = element_blank(),
    strip.text.x = element_text(size = 6), #EAG
    strip.text.y = element_text(size = 5), #EKR
    axis.text.x = element_text(size= 5, angle=90,hjust=1),
    axis.text.y = element_text(size= 5, hjust=2),
    axis.ticks =  element_line(colour = "black"),
    panel.background = element_blank(),
    plot.background = element_blank()
  )+
  ggtitle("Totale visbiomassa tov fosforbelasting") +
  labs(x= 'P-bel', y= 'biomassa')
# krw <-
ggplotly(p=p)
# saveWidget(krw, "visversuskP.html", selfcontained = FALSE)
```

```{r brasembiomvsp, fig.cap = 'Visbiomassa versus fosforbelasting', eval = FALSE, echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}

selKol <- c("Numeriekewaarde","Biotaxon.naam.nl","HoortBijGeoobject.identificatie","Begindatum","Resultaatdatum","HoortBijGeoObjectCode","Eenheid.code","GeoObject.code")
sel <- !grepl('^NL11*', EKRlijst$HoortBijGeoobject.identificatie)
sel <- sel & !is.na(EKRlijst$Biotaxon.naam.nl) & EKRlijst$Biotaxon.naam.nl %in% c('Brasem','Karper') &!(EKRlijst$Biotaxon.naam.nl %in% "Vissen")  #als geen nederlandse naam dan gaat aggregate fout. En ook niet relevant.
sel <- sel & EKRlijst$Eenheid.code %in% "kg/ha"
EKRlijst1 <- EKRlijst[sel,]

xagg <- aggregate(Numeriekewaarde ~ Biotaxon.naam.nl+jaar+HoortBijGeoobject.identificatie+GeoObject.code,EKRlijst1,FUN=sum)
xagg$jaar <- as.character(xagg$jaar)
xagg <- aggregate(Numeriekewaarde ~ jaar+HoortBijGeoobject.identificatie+GeoObject.code,xagg,FUN=sum)


colgroup <-c('jaar','HoortBijGeoobject.identificatie','Numeriekewaarde','GeoObject.code')
# rename columns and order data.table
setnames(xagg,colgroup,c('jaar','waterlichaam','biomassa','ident'))

#merge vis en pbel

visbelasbrkp <- merge(xagg, pvskp, by.x = 'ident', by.y = 'KRW')

p<- ggplot(visbelasbrkp, aes(x= wp_min_sum, y= biomassa, col = watertype, label = paste0(waterlichaam, jaar.x)))+
  geom_jitter() +
  #facet_grid(~jaar, scales = 'free')+
  theme_minimal()+
  theme(
    strip.background = element_blank(),
    strip.text.x = element_text(size = 6), #EAG
    strip.text.y = element_text(size = 5), #EKR
    axis.text.x = element_text(size= 5, angle=90,hjust=1),
    axis.text.y = element_text(size= 5, hjust=2),
    axis.ticks =  element_line(colour = "black"),
    panel.background = element_blank(),
    plot.background = element_blank()
  )+
  ggtitle("Biomassa braem en karper tov fosforbelasting") +
  labs(x= 'P-bel', y= 'biomassa')
# krw <-
ggplotly(p=p)
# saveWidget(krw, "brasemkarperversuskP.html", selfcontained = FALSE)
```

#### Ontwikkeling Vis

In afbeelding \@ref(fig:kaartvisjaren) is te zien hoe vis scoort in verschillende meetjaren. Er worden 3 meetjaren op één kaart weergegeven zodat er een zo goed mogelijk gebiedsbreed beeld wordt gegeven. In ieder vlak (EAG) wordt namelijk maar één keer per 3 jaar vegetatie gemeten. Om te kunnen zien waar de gemiddelde EKR score uit is opgebouwd, kunnen EKR scores ook per meetpunt worden weergegeven. In de afbeelding hieronder staat zowel de score per EAG als de ruimtelijke spreiding van de ecologische kwaliteit op basis van de berekende EKR score per meetlocatie. 

```{r kaartvisjaren, fig.cap = 'Overzicht van gemiddelde EKR scores per EAG van de laatste 3 meetjaren op de maatlat vis', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
#krw <-
combineWidgets(
  ncol = 4, colsize = c(1,1),
  ekrmapKRW(EKRset[EKRset$jaar >= '2006' & EKRset$jaar < '2010' & EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Vis",],
            gKRW, maatlat = "4VI1 Vis-kwaliteit" , col=col,labels=labels),
  ekrmapKRW(EKRset[EKRset$jaar >= '2010' & EKRset$jaar < '2013'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Vis",],
            gKRW,   maatlat = "4VI1 Vis-kwaliteit" ,col=col,labels=labels),
  ekrmapKRW(EKRset[EKRset$jaar >= '2013' & EKRset$jaar < '2016'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Vis",], 
            gKRW,   maatlat = "4VI1 Vis-kwaliteit" ,col=col,labels=labels),
  ekrmapKRW(EKRset[EKRset$jaar >= '2016' & EKRset$jaar < '2020'& EKRset$Waardebepalingsmethode.code == "Maatlatten2018 Vis",], 
            gKRW,  maatlat = "4VI1 Vis-kwaliteit" ,col=col,labels=labels))
# saveWidget(krw, "vismpjaren.html", selfcontained = FALSE)
# webshot("vismpjaren.html", file = "vis.png")
```

De ontwikkeling van de ecologische kwaliteit is met een lineaire trend. Uit deze trends in de toestand van waterkwaliteit blijkt dat op veel plaatsen vis achteruit gaat. In `r round((length(ekrtrend$estimate[ekrtrend$GHPR_level == '4VI1 Vis-kwaliteit' & ekrtrend$estimate < 0 & !is.na(ekrtrend$estimate)])/length(ekrtrend$estimate[ekrtrend$GHPR_level == '4VI1 Vis-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat ze achteruit zijn gegaan.

Er zijn ook ecologisch analysegebied waar de ecologische kwaliteit verbetert. In `r round((length(ekrtrend$estimate[ekrtrend$GHPR_level == '4VI1 Vis-kwaliteit' & ekrtrend$estimate > 0 & !is.na(ekrtrend$estimate)])/length(ekrtrend$estimate[ekrtrend$GHPR_level == '4VI1 Vis-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is met een hoge betrouwbaarheid vast te stellen dat de vegetatie vooruit is gegaan. De succesfactoren voor het herstel van deze waterlichamen worden per factor toegelicht in het rapport Ecologische sleutelfactoren in beeld.

In `r round((length(ekrtrend$estimate[ekrtrend$GHPR_level == '4VI1 Vis-kwaliteit' & (ekrtrend$estimate == 0| is.na(ekrtrend$estimate))])/length(ekrtrend$estimate[ekrtrend$GHPR_level == '4VI1 Vis-kwaliteit']))*100, 0)`% van de gebieden en maatlatten is de ontwikkeling in ecologische waterkwaliteit min of meer stabiel of zijn er onvoldoende gegevens beschikbaar om de ontwikkeling goed in beeld te brengen. 

```{r trendvis1, fig.cap = 'Overzicht van de trend in EKR scores op de maatlat vis per ecologisch analysegebied tussen 2006 en 2021', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
# only aggregated scores per KRW waterbody 4 fish
ekrtrend <- trendekreag[!grepl("^NL11_*",id), ]

#krw<-
combineWidgets(
  ncol = 2,
  plottrendKRW(ekrtrend[ekrtrend$GHPR_level %in% c('4VI2 Massafractie Visgilde - plantminnende soort (Pm)','4VI2 Soortenrijkdom Visgilde - plantminnende en migrerende soort (PmM)'),], gKRW),
  plottrendKRW(ekrtrend[ekrtrend$GHPR_level == '4VI2 Massafractie Visgilde - zuurstoftolerante soort (O2)',], gKRW)
)

combineWidgets(
  ncol = 2,
  plottrendKRW(ekrtrend[ekrtrend$GHPR_level == '4VI2 Massafractie Visgroep - brasem en karper (BK)',], gKRW),
  plottrendKRW(ekrtrend[ekrtrend$GHPR_level == '4VI2 Massafractie Visgroep - baars en blankvoorn (BB)',], gKRW)
)
#saveWidget(krw, "visdeelmtlt.html", selfcontained = FALSE)
```


# Methoden
## KRW toetsing

Alle beschikbare meetgegevens van hydrobiologische kwaliteitselementen zijn getoetst aan landelijke
beoordelingsmethodiek voor sloten, kanalen (Omschrijving MEP en maatlatten voor sloten en kanalen, STOWA rapport 2012-34) en meren (Referenties en maatlatten voor natuurlijke watertypen voor de Kaderrichtlijn Water, STOWA rapport 2012-31). Het resultaat hiervan is een duiding van ecologische kwaliteit (EKR score). 

Er kan slechts aan één watertype getoetst worden, omdat één waterlichaam volgens de Europese richtlijn, slechts uit één watertype kan bestaan. Er wordt getoetst aan de watertypen zoals vastgesteld in het WBP 2016-2021. Er zijn toestgegevens beschikbaar van gehele KRW waterlichamen en EAG`s. Het watertype waaraan getoetst wordt als pop-up weergegeven in de kaarten in paragrafen [KRW waterlichamen] en [Ecologische analysegebieden].

### KRW waterlichamen

Voor de KRW is een groot deel van het oppervlaktewater aangewezen als waterlichaam. Een waterlichaam is een "onderscheiden oppervlaktewater van aanzienlijke omvang, zoals een meer, een rivier of een kanaal". Voor deze wateren moet de toestand van het aquatisch ecosysteem beschreven worden. Onder oppervlaktewater van "aanzienlijke omvang" vallen waterlichamen met een minimale oppervlakte van 0,5 km2 of een stroomgebied tussen de 10 en 100 km2. In onderstaande afbeelding staan de KRW waterlichamen in het beheergebied van AGV.

In de Kaderrichtlijn Water (KRW) is een indeling gemaakt in verschillende typen oppervlaktewater. Deze zijn ingedeeld naar hydromorfologische eigenschappen, type bodem en naar zoet, brak of zout water. De hydromorfologische eigenschappen zijn de stroming, de grootte of breedte en de diepte. Een belangrijk onderscheid is in stilstaand of stromend water. De bodem is belangrijk voor het onderscheid naar een veenbodem (met veel organisch materiaal), kiezels, klei, zand of kalk. Deze indeling is belangrijk voor de doelen die in de KRW gesteld worden, omdat voor elk watertype kwaliteitseisen opgesteld zijn. De watertypen worden zichtbaar wanneer er op een waterlichaam wordt geklikt.

```{r wl, fig.cap = 'Overzicht van KRW waterlichamen in het beheergebied van AGV', echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE, out.width="100%", fig.show='hold'}
## Dissolve polygons with same area IDs ---------
kaartkrw <- gKRW %>% dplyr::group_by(OWMIDENT,OWMNAAM) %>% dplyr::summarize(geometry = sf::st_union(geom))

eag_wl1 <- eag_wl %>% dplyr::group_by(KRW_SGBP3,watertype) %>% dplyr::summarize()
kaartkrw <- merge(kaartkrw, eag_wl1[!eag_wl1$KRW_SGBP3 =="",c('KRW_SGBP3','watertype')], by.x = "OWMIDENT", by.y = "KRW_SGBP3", all.x = TRUE, all.y = F)%>% st_transform(4326)
# krw <-
krwmap(kaartkrw, gEAG)
# saveWidget(krw, "waterlichamen.html", selfcontained = FALSE)
#webshot("waterlichamen.html", file = "waterlichamen.png")
```

### Ecologische analysegebieden

De Ecologische analysegebieden zijn een gebiedsindeling om het ecologisch functioneren van het watersysteem te beoordelen en het effect van maatregelen op de waterkwaliteit te volgen, waarbij gebruik wordt gemaakt van analysemodellen zoals de water- en stoffenbalans, opdat het waterbeheer doelmatig en efficiënt kan plaatsvinden en KRW-doelstellingen worden behaald.

Ecologische analysegebieden (EAG’s) zijn een opdelingen van af- en aanvoergebieden en meestal delen van polders. De opdeling in EAG’s is gemaakt op basis van een aantal kenmerken zoals vorm, verblijftijd, waterdiepte, strijklengte, de aanwezigheid van kwel of wegzijging en de afvoerrichting van het water. Een EAG valt altijd volledig binnen een afvoergebied. Af-en aanvoergebieden, maar ook KRW-waterlichamen, zijn dus opgebouwd uit één of meer EAG’s.

Ook EAG`s in het 'overig water' die niet zijn aangewezen als KRW waterlichaam hebben een KRW watertype toegekend gekregen.

```{r eag1, fig.cap = 'Overzicht van Ecologische analysegebieden in het beheergebied van AGV', echo = FALSE, message = FALSE, warning = FALSE, out.width="100%", fig.show='hold'}
eagoverzicht(gEAG, eag_wl)
```

### Selectie monsters

Alleen meetjaren waarin een geheel waterlichaam of EAG is bemonsterd zijn meegenomen in de toetsing om een representatief beeld te krijgen van de ecologische toestand. In de waterlichamen Tussenboezem Vinkeveen B en Molenpolder en Tienhoven zijn in verschillende deelgebieden niet bemonsterd in het verleden, om toch een beeld te krijgen van de ontwikkeling in ecologische toestand in deze gebieden is de beperkte dataset van deze deelgebieden wél meegenomen. Dit kan een vertekend beeld geven, omdat de deelgebieden die meewegen in de eindscore van het gehele waterlichaam variëren per meetjaar.

Monsters die zijn genomen ten behoeve van projectmeetnetten om bijvoorbeeld een specifieke maatregel te evalueren worden dus niet meegenomen in de (formele) KRW-toestandsbepaling. Een voorbeeld hiervan zijn vegetatieopnamen die zijn gemaakt in natuurvriendelijke oevers.

Macrofauna dat is bemonsterd onder de spronglaag in diepe plassen wordt niet meegenomen in de toetsing.

### Agregeren in ruimte

De wijze van aggregatie verschilt per biologisch kwaliteitselement.Aggregatie van monsters tot "KRW-meetpunt" (Meetobject in IM-metingen) gebeurt door het (gewogen) middelen van meetresultaten of berekende EKR’s van monsters. Aggregatie van meetpunt tot KRW-monitoringslocatie (deze staat gelijk aan één waterlichaam) gebeurt door het (gewogen) middelen van EKR-scores van
meetpunten.

#### Weging meetlocaties en trajecten

Bij biologische kwaliteitselementen is er een weging aan meetpunten toegekend. Er is rekening gehouden met het relatieve aandeel dat een deelgebied heeft in een geheel KRW waterlichaam en de bemonsteringsinspanning binnen een deelgebied. De wijze waarop de weegfactoren zijn uitgerekend, verschilt per watertype en kwaliteitselement.

Voor macrofauna, fytoplankton en macrofyten is de volgende formule toegepast:
  
  $$
  \begin{aligned}
Gewicht per meetlocatie = 
  \frac{wateroppervlakte van het deelgebied waar de locatie in valt}{wateroppervlakte van het waterlichaam waar de locatie in valt \times totaal aantal meetlocaties in een deelgebied}
\end{aligned}
$$
  
  Ecologische Analyse Gebieden (EAG) zijn deelgebieden in deze weging. Monitoring van macrofyten vindt plaats over de complete dieptegradiënt. Bij macrofyten wordt onderscheid gemaakt tussen monsters in de emerse zone (ez) en monsters in de open water of submerse zone (sz). Een macrofytenmonster op één meetlocatie in meren en plassen bevat niet de gehele vegetatiegradiënt, maar één vegetatiezone (een diepere submerse zone, de ondiepe emerse zone of een oeverzone). Voor de toetsing zijn monsters uit verschillende vegetatiezones samengevoegd tot één meetlocatie, zodat iedere locatie alle vegetatiezones (oever, emers en submers) bevat. Dit betekent dat dezelfde monsters soms meerdere malen aan een meetlocatie zijn toegekend en dat de alle monsters in de emerse zone gezamelijk even zwaar meetellen als alle monsters in de submerse zone. Bij het toewijzen van monsters worden monsterpunten aan elkaar gekoppeld op basis van de kortste afstand waarbij alle meetlocaties in iedere vegetatiezone evenredig vertegenwoordigd zijn. 


Bij vis is de volgende formule toegepast:
  
  $$
  \begin{aligned}
Gewicht per traject = 
  (\frac{wateroppervlak van het deelgebied waar het traject in valt}{wateroppervlak van het beviste waterlichaam waar het traject in valt}) \times
(\frac{bevist oppervlak van traject}{totaal bevist oppervlak van alle trajecten in het deelgebied})
\end{aligned}
$$
  
In lijnvormige wateren (M1, M8, M10) wordt gevist met een elektrisch schepnet of met een elektrisch schepnet in combinatie met een zegen en keernetten. In het laatste geval vallen er twee monsters onder één traject en wordt deze samengevoegd. Het bevist oppervlak is dan per traject gesommeerd. In meervormige wateren en de boezem (M14, M27, M20, M7, M6) worden naast EAG's ook aparte deelgebieden onderscheidden per dieptezone (0-1 meter, 1-8 meter, >8 meter). Het oppervlak van de emerse zone (0-1 meter) is over het algemeen klein in vergelijking tot het totaal oppervlak van waterlichamen van deze watertypen. Daarom weegt de emerse zone, waar de meeste vis zit, minder zwaar mee dan de overige dieptezones. Soms zitten er lijnvormige wateren vast aan een plas. Deze worden bevist met electrisch schepnet (en zegen) met keernetten. Deze worden als apart deelgebied ook meegewogen.
  
#### Afwijking voorschrift protocol toetsen en beoordelen 

Het Handboek Hydrobiologie (Bijkerk, 2014) kent verschillende methoden voor het monitoren van watervegetatie. Het basisprincipe is dat er een zo adequaat mogelijke beschrijving wordt gegeven van de aanwezige begroeiing. De mogelijkheden om dat efficiënt te doen, zijn echter niet voor alle watertypen hetzelfde en daarom worden er verschillende methoden beschreven. Dit heeft ook consequenties voor de toepassing van de maatlatten. Voor macrofyten in zoete meren en plassen wordt sinds 2014 in het protocol toetsen en beoordelen voorgeschreven dat een KRW-monitoringslocatie één of meerdere opnamen over de gehele vegetatiegradiënt moet bevatten. Een KRW-monitoringslocatie vertegenwoordigt het gehele waterlichaam of een deel(-gebied) ervan. Voor de beoordeling is het noodzakelijk KRW-monitoringslocaties te definiëren die een deelgebied van het waterlichaam vertegenwoordigen, waarbij de scheidslijnen van de deelgebieden dwars op de oever liggen, net als bij lijnvormige waterlichamen. Voor de deelmaatlat abundantie groeivormen vindt aggregatie plaats door de bedekkingen per groeivorm in de verschillende opnamen rekenkundig te middelen, waarbij eventueel weging plaatsvindt. Voor de deelmaatlat soortensamenstelling vindt aggregatie plaats door een totale soortenlijst samen te stellen. De scores voor de bedekkingen per soort worden daarbij (gewogen) gemiddeld. Met dit voorschrift wordt het toetsresultaat afhankelijk van de bemonsteringsinspanning (e.g. hoe meer monsters worden geaggregeerd tot één KRW-monitoringslocatie, hoe groter de kans is dat bepaalde soorten worden aangetroffen). De bemonsteringsinspanning varieert per waterlichaam in het beheergebied van AGV en kan ook variëren per meetjaar omdat inzichten, monitoringsbudgetten en de hetrogeniteit van gebieden bepalend zijn voor de monitoringsinspanning. Om te voorkomen dat de toetsing afhankelijk wordt van deze variërende inspanning wijkt Waternet bewust af van dit voorschrift. Het protocol schrijft ook voor dat de wegingsfactor voor beide deelmaatlatten (abundantie groeivormen en soortensamenstelling) wordt bepaald door de breedte van de zone waarin de opname is gemaakt, gedeeld door het aantal opnamen dat in dezelfde zone is gemaakt. Let wel, de groeivormen emers, drijfbladplanten, FLAB en kroos worden alleen beoordeeld in de emerse zone bij de watertypen die voorkomen in het beheergebied van AGV. Er wordt niet gewogen als alle opnamen in dezelfde mate representatief zijn of worden geacht. Een vuistregel is dat weging achterwege mag blijven als de grootste wegingsfactor niet groter is dan 2 keer de kleinste. In veel Waterlichamen in het beheergebied van AGV is de omvang van de emerse zone (tussen de 0 en 1 meter diep) tussen de 5 en 20 keer kleiner dan de omvang van de submerse zone tussen de 1 en 3 meter diep. Toch worden alle opnamen in de emerse zone even zwaar gewogen als de opnamen in de submerse zone omdat de breedte van de verschillende vegetatiezones niet voor ieder waterlichaam bekend is en de emerse en submerse zone in het verleden (voor 2014) ook even zwaar wordt gewogen. Daarnaast wordt in de Aquo-kit een parameter bemonsteringsbreedte als weegfactor gebruikt en de definitie van deze parameter ('breedte betreffende de bemonstering zelf') week af van de definitie ('breedte van de zone waarin de opname is gemaakt') in het protocol toetsen en beoordelen. 

Voor de biologische indicator “bedekkingen drijfbladplanten” in de emerse zone heeft AGV ook geen doelen gesteld, omdat er geen maatregelen beschikbaar zijn om deze vegetatie effectief te bevorderen en omdat de EKR de werkelijke ecologische kwaliteit onvoldoende representeert. De bedekking met drijfbladvegetatie wordt wel gemonitord en meegenomen in de toetsing. Drijfbladvegetaties komen plaatselijk voor, in de vorm van velden gele plomp, waterlelie en/of watergentiaan. De dichtheid in deze velden is vaak erg hoog. Ecologisch gezien zijn deze velden waardevol, zeker in grotere meren. Het probleem bij deze maatlat is dat opnames met dergelijke velden met een bedekking boven de 30% een lagere EKR-score opleveren. Dat komt omdat het oorspronkelijk een maatlat voor kleine wateren was, die niet helemaal dicht moeten groeien. Deze is nu ook op de grotere plassen van toepassing verklaard. Dat betekent dat een hoge natuurwaarde een lage beoordeling oplevert.  

In meren met watertype M20, M27 en M14 zijn de taxa van submerse vegetatie verwijderd uit het monster uit de emerse zone, omdat een enkele meting van een minder soortenrijke onderwatervegetatie in de emerse zone anders onevenredig zwaar meeweegt in de toetsing. Het komt echter ook voor dat er meer opnamen zijn gemaakt in de emerse dan submerse zone in waterlichamen van deze watertypen. Wanneer dit zo is worden de taxa in de emerse zone niet verwijderd uit de monsters. De lijnvormige watergangen die binnen de begrenzing van waterlichamen van een “meervormig type” liggen, worden als emerse zone beschouwd. Hier zou zowel de emerse als submerse vegetatie meegenomen moeten worden in de toetsing, maar dit gebeurt (nog) niet altijd. Dit kan worden opgelost door wel een weegfactor op basis van de breedte van verschillende begroeibare arealen toe te passen.


### Agregeren in tijd

Aggregeren van EKR-scores van meerdere jaren is aan de orde bij de formele KRW-beoordeling, waarbij een periodeoordeel van de toestand van het waterlichaam wordt bepaald. Hierbij wordt de geaggregeerde EKR-score getoetst aan het KRW-doel. Voor het bepalen van een periodeoordeel worden de laatste drie meetjaren gebruikt, waarbij de EKR-waarden van de drie meetjaren worden gemiddeld. Deze gemiddelde EKR-waarde wordt getoetst aan het KRW-doel. De te gebruiken biologische gegevens mogen de planperiode overschrijden, maar mogen niet ouder zijn dan 10 jaar vóór het rapportagejaar.

### Conversie & aanvulling data

Fytoplankton is bij monsters die voor 2014 zijn genomen, alleen als waarnemingen per milliliter gerapporteerd. Voor de toetsing is de eenheid cellen/ml nodig. Meetwaarden van 2014 en eerder zijn vertaald naar cellen/ml met behulp van de vertaaltabel in (Referenties en maatlatten voor natuurlijke watertypen voor de Kaderrichtlijn Water, STOWA rapport 2012-31).

De vestigingsdiepte van vegetatie is pas vanaf 2013 bepaald. Vestigingsdiepte in eerdere meetjaren is berekend op basis van de gemeten verticale extinctie. De vestigingsdiepte is afgeleid uit verticale extinctie obv de berekende lineaire relatie tussen vestigingsdiepte en verticale extinctie in diepe plassen in 2014 t/m 2017. Er zijn twee correcties op deze berekening toegepast:
    1. Wanneer de gemeten submerse bedekking 0 is, is de vestigingsdiepte ook op 0 gezet. 
    2. Wanneer de berekende vestigingsdiepte kleiner is dan de maximale diepte waarop submerse bedekking is gevonden, dan is de diepte waarop submerse bedekking is gevonden voor de toetsing gebruikt.
    
Groeivormen worden aangevuld wanneer ze ontbreken in de data:
* Het sluitingspercentage en breedte van de oeverzone wordt alleen in het Naardermeer bepaald. Bij het afleiden van KRW doelen is er geen ambitie voor de ontwikkeling van oevervegetatie in andere waterlichamen, omdat oevervegetatie in de zone tussen de hoog- en de laagwaterlijn niet in deze kunstmatige wateren kan worden verwacht. Oevers worden ook niet gemonitord binnen het KRW monitoringsprogramma. De parameters waarmee de biologische indicator “oevervegetatie” wordt geïndiceerd zijn 1) De breedte van oevervegetatie, 2) Het sluitingspercentage van de oevervegetatie. Deze parameters zijn standaard op 0 gezet in de toestandbepaling.
* Grote drijfbladplanten in meren en plassen wordt berekend door de som van drijvende taxa wanneer deze ontbreekt. 
* Emerse planten, FLAB en KROOS staan op 0 waar ze missen, omdat deze niet uit de data kunnen worden afgeleid. 

De abundantie van vegetatie wordt vertaald naar een driedelige-KRW-opnameschaal. Gehanteerde grenswaarde tussen 'weinig', 'matig' en 'veel' bij verschillende vegetatieopnameschalen zijn:

*	Tansley schaal: 4, 8
*	Nat schaal: 2, 6
*	Bedekkingspercentages: 5, 50

## Trendanalyse

Per (deel)maatlat en ecologisch analysegebied is een lineaire trend in EKR-scores van alle beschikbare meetjaren bepaald. In de figuren met trends in EKR scores worden alleen trends getoond van gebieden waar voor minimaal 2 meetjaren gegevens beschikbaar zijn en waarvan de relevantie voldoende is (meer dan 0.05 ekr per 12 jaar).

# Bijlagen

```{r toestandtrend, fig.cap = "Toestand, oordeel en ontwikkeling", echo = FALSE, message = FALSE, warning= FALSE, out.width='100%', eval = FALSE, include = FALSE}

# hier dcast om tabel met header kwaliteitslementen te maken ------

ekrtrend$EKR3jr <- round(ekrtrend$EKR3jr,2)
ekrtrend$estimate <- round(ekrtrend$estimate,2)
ekr_scores_sel2 <- dcast.data.table(setDT(ekrtrend), waterlichaam+KRW_SGBP3 ~ facet_wrap_code, value.var = c("EKR3jr","oordeelsort","estimate","GEP_2022"), fun.aggregate = mean)

typology <- data.frame(
  col_keys = c( "waterlichaam", 
                          "EKR3jr_Fytoplankton","GEP_2022_Fytoplankton","estimate_Fytoplankton",
                          "EKR3jr_Macrofauna","GEP_2022_Macrofauna","estimate_Macrofauna",
                          "EKR3jr_Waterflora","GEP_2022_Waterflora","estimate_Waterflora",
                          "EKR3jr_Vis", "GEP_2022_Vis","estimate_Vis"),
  what = c("Waterlichaam",
           "Fytoplankton", "Fytoplankton", "Fytoplankton",
           "Macrofauna","Macrofauna","Macrofauna",
           "Waterflora","Waterflora","Waterflora",
           "Vis","Vis","Vis"),
  measure = c("Waterlichaam",
              "EKR3jr", "GEP", "trend",
              "EKR3jr", "GEP", "trend",
              "EKR3jr", "GEP", "trend",
              "EKR3jr", "GEP", "trend"),
  stringsAsFactors = FALSE )

#ft<- 
  ekr_scores_sel2 %>%
    flextable(col_keys = c("waterlichaam",
                           "EKR3jr_Fytoplankton","GEP_2022_Fytoplankton","estimate_Fytoplankton",
                           "EKR3jr_Macrofauna","GEP_2022_Macrofauna","estimate_Macrofauna",
                           "EKR3jr_Waterflora","GEP_2022_Waterflora","estimate_Waterflora",
                           "EKR3jr_Vis", "GEP_2022_Vis","estimate_Vis")) %>%
    set_header_df(mapping = typology, key = "col_keys" )%>%
    merge_h(part = "header")%>%
    merge_v(part = "header")%>%
    theme_booktabs()%>%
    border_inner(border= fp_border(width = 3, color = "white"), part="all")%>%
    colformat_num(j = 2:13, digits=2)%>%
    width(j = 1, width = 5)%>%
    width(j = 2:13, width = 1)%>%
    bg(~ oordeelsort_Fytoplankton > 1, bg = "green", ~ EKR3jr_Fytoplankton)%>%
    bg(~ oordeelsort_Fytoplankton < 1, bg = "yellow", ~ EKR3jr_Fytoplankton)%>%
    bg(~ oordeelsort_Fytoplankton < 0.67, bg = "orange", ~ EKR3jr_Fytoplankton)%>%
    bg(~ oordeelsort_Fytoplankton < 0.34, bg = "red", ~ EKR3jr_Fytoplankton)%>%
    bg(~ oordeelsort_Macrofauna > 1, bg = "green", ~ EKR3jr_Macrofauna)%>%
    bg(~ oordeelsort_Macrofauna < 1, bg = "yellow", ~ EKR3jr_Macrofauna)%>%
    bg(~ oordeelsort_Macrofauna < 0.67, bg = "orange", ~ EKR3jr_Macrofauna)%>%
    bg(~ oordeelsort_Macrofauna < 0.34, bg = "red", ~ EKR3jr_Macrofauna)%>%
    bg(~ oordeelsort_Waterflora > 1, bg = "green", ~ EKR3jr_Waterflora)%>%
    bg(~ oordeelsort_Waterflora < 1, bg = "yellow", ~ EKR3jr_Waterflora)%>%
    bg(~ oordeelsort_Waterflora < 0.67, bg = "orange", ~ EKR3jr_Waterflora)%>%
    bg(~ oordeelsort_Waterflora < 0.34, bg = "red", ~ EKR3jr_Waterflora)%>%
    bg(~ oordeelsort_Vis > 1, bg = "green", ~ EKR3jr_Vis)%>%
    bg(~ oordeelsort_Vis < 1, bg = "yellow", ~ EKR3jr_Vis)%>%
    bg(~ oordeelsort_Vis < 0.67, bg = "orange", ~ EKR3jr_Vis)%>%
    bg(~ oordeelsort_Vis < 0.34, bg = "red", ~ EKR3jr_Vis)%>%
    bg(~ estimate_Fytoplankton > 0, bg = "lightgreen", ~ estimate_Fytoplankton)%>%
    bg(~ estimate_Fytoplankton == 0, bg = "lightyellow", ~ estimate_Fytoplankton)%>%
    bg(~ estimate_Fytoplankton < 0, bg = "salmon", ~ estimate_Fytoplankton)%>%
    bg(~ estimate_Waterflora > 0, bg = "lightgreen", ~ estimate_Waterflora)%>%
    bg(~ estimate_Waterflora == 0, bg = "lightyellow", ~ estimate_Waterflora)%>%
    bg(~ estimate_Waterflora < 0, bg = "salmon", ~ estimate_Waterflora)%>%
    bg(~ estimate_Macrofauna > 0, bg = "lightgreen", ~ estimate_Macrofauna)%>%
    bg(~ estimate_Macrofauna == 0, bg = "lightyellow", ~ estimate_Macrofauna)%>%
    bg(~ estimate_Macrofauna < 0, bg = "salmon", ~ estimate_Macrofauna)%>%
    bg(~ estimate_Vis > 0, bg = "lightgreen", ~ estimate_Vis)%>%
    bg(~ estimate_Vis == 0, bg = "lightyellow", ~ estimate_Vis)%>%
    bg(~ estimate_Vis < 0, bg = "salmon", ~ estimate_Vis)

# save_as_docx(ft, path = "ekrtrendkrwovwat.docx")
    
```

## Data en code

Deze rapportage is gemaakt door middel computercode (R en Rmarkdown) hierdoor is deze rapportage volledig reproduceerbaar. De gebruikte code en de gebruikte data zijn beschikbaar via onderstaande link.

[Download hier de code](https://github.com/AgroCares/WaterEcoInzicht) 





